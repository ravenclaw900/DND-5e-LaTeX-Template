% \iffalse
%<*dndoptions>
\ExplSyntaxOn

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Class / Package options
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Provides class / package option processing of l3keys in LaTeX2e
\RequirePackage {l3keys2e}

%% deprecate warning used in options and throughout the collection
\msg_new:nnn {dnd} {deprecated} { #1 ~ is ~ deprecated ~ and ~ will ~ be ~ removed ~ in ~ version ~ #2. ~ #3 }

\cs_new_protected:Npn { \__dnd_deprecated:nnn } #1#2#3
  {
    \msg_warning:nnnnn { dnd } { deprecated } {#1} {#2} {#3}
  }

\cs_new_protected:Npn { \__dnd_deprecated:nn } #1#2
  {
    \msg_warning:nnnnn { dnd } { deprecated } {#1} {#2} {}
  }

%% Messages for unknown options
\msg_new:nnn {dnd} { options / unknown_class } { Unknown ~ option ~ " #1 " ~ passed ~ to ~ book ~ class. }
\msg_new:nnn {dnd} { options / unknown_package } { Unknown ~ option ~ " #1 ". }

%% These booleans are not set directly by an option (i.e. instead set by .code)
\bool_new:N \l__dnd_show_background_bool
\bool_new:N \l__dnd_show_footer_scroll_bool
\bool_new:N \l__dnd_justified_bool
\bool_new:N \l__dnd_multitoc_bool
\bool_new:N \l__dnd_layout_bool
\bool_new:N \l__dnd_no_deprecated_code_bool

\bool_set_true:N \l__dnd_multitoc_bool
\bool_set_eq:NN \l__dnd_layout_bool \c__dnd_isclass_bool

%% BEGIN section to remove in version 1.0.0
\bool_set_true:N \l__dnd_layout_bool
\bool_new:N \l__dnd_layout_set_bool
%% END section to remove in version 1.0.0

\keys_define:nn { dnd / options }
  {
    % Large-scale styling choice
    bg .choice:,
    bg / full .code:n =
      {
        \bool_set_true:N \l__dnd_show_background_bool
        \bool_set_true:N \l__dnd_show_footer_scroll_bool
      },
    bg / print .code:n =
      {
        \bool_set_false:N \l__dnd_show_background_bool
        \bool_set_true:N \l__dnd_show_footer_scroll_bool
      },
    bg / none .code:n =
      {
        \bool_set_false:N \l__dnd_show_background_bool
        \bool_set_false:N \l__dnd_show_footer_scroll_bool
      },
    bg .initial:n = full,

    % Justified text
    justified .code:n =
      {
        \bool_set_true:N \l__dnd_justified_bool
      },
    justified .value_forbidden:n = true,

    % Suppress deprecated code
    nodeprecatedcode .code:n =
      {
        \bool_set_true:N \l__dnd_no_deprecated_code_bool
      },
    nodeprecatedcode .value_forbidden:n = true,

    % Avoid multi-column toc
    nomultitoc .code:n =
      {
        \bool_set_false:N \l__dnd_multitoc_bool
      },
    nomultitoc .value_forbidden:n = true,

    % Apply layout formatting
    %layout .bool_set:N       = \l__dnd_layout_bool,
    layout .code:n =
      {
        \tl_if_eq:nnTF {true} {#1}
          { \bool_set_true:N \l__dnd_layout_bool }
          { \bool_set_false:N \l__dnd_layout_bool }
        \bool_set_true:N \l__dnd_layout_set_bool
      }, % Remove and replace with .bool_set:N in 1.0.0
    layout .value_required:n = true,

    % Unknown option handling
    unknown .code:n =
    {
      \bool_if:NTF \c__dnd_isclass_bool
        {
          \msg_info:nnx { dnd } { options / unknown_class } {\l_keys_key_tl}
          \PassOptionsToClass { \l_keys_key_tl } { book }
        }
        {
          \msg_error:nnx { dnd } { options / unknown_package } {\l_keys_key_tl}
        }
    },

    % Deprecated options
    bg-full .code:n =
      {
        \__dnd_deprecated:nnn { Option ~ "bg-full" } {1.0} { Use ~ "bg = full" ~ instead. }
        \bool_set_true:N \l__dnd_show_background_bool
        \bool_set_true:N \l__dnd_show_footer_scroll_bool
      },
    bg-full .value_forbidden:n = true,
    bg-none .code:n =
      {
        \__dnd_deprecated:nnn { Option ~ "bg-none" } {1.0} { Use ~ "bg = none" ~ instead. }
      },
    bg-none .value_forbidden:n = true,
    bg-print .code:n =
      {
        \__dnd_deprecated:nnn { Option ~ "bg-print" } {1.0} { Use ~ "bg = print" ~ instead. }
        \bool_set_true:N \l__dnd_show_footer_scroll_bool
      },
    bg-print .value_forbidden:n = true,
  }

\ProcessKeysOptions { dnd / options }

%% BEGIN section to remove in version 1.0.0
\bool_if:NF \c__dnd_isclass_bool
  {
    \bool_if:NF \l__dnd_layout_set_bool
      {
        \msg_new:nnn {dnd} { options / layout_false } { Package ~ option ~ "layout" ~ will ~ default ~ to ~ false ~ in ~ 1.0.0. }
        \msg_warning:nn {dnd} { options / layout_false }
      }
  }
%% END section to remove in version 1.0.0
%</dndoptions>
%<*dndcore>
\ExplSyntaxOn

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Package Dependencies
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Helps prevent option clash with other packages that include xcolor
\PassOptionsToPackage {table} {xcolor}

\RequirePackage {array}
\RequirePackage {colortbl}
\RequirePackage {enumitem}
\RequirePackage {etoolbox}
\RequirePackage {textcomp,gensymb} % degree symbol for italian ordinals
\RequirePackage {hang} % hanging paragraphs
\RequirePackage [autolanguage] {numprint} % localization of thousands separator
\RequirePackage {tabularx} % variable-width table columns
\RequirePackage [breakable,skins,xparse]{tcolorbox} % styled text boxes
\RequirePackage {tikz} % drawing ornaments and lines
\RequirePackage {xcolor}
\RequirePackage {xparse} % \NewDocumentCommand and expl3

\sys_if_engine_luatex:T
  {
    \RequirePackage {luacolor}
  }

\bool_if:NT \l__dnd_layout_bool
  {
    \RequirePackage {geometry}
    \RequirePackage {microtype} % Improve ragged2e hyphenation and overfull boxes
    \RequirePackage {ragged2e}
    \RequirePackage [titles] {tocloft} % multi-column toc
    \RequirePackage [newparttoc] {titlesec}  % Used to adjust (sub)section, part, and table of contents formatting

    \bool_if:NT \l__dnd_multitoc_bool
      { \RequirePackage [toc] {multitoc} }

    % Set page geometry.
    \geometry
      {
        hmargin   = .75in, % Left and right margins
        top       = .46in, % Top of text area to top of page
        bottom    = .8in,  % Bottom of text area to bottom of page
        footskip  = .32in, % Bottom of text area to bottom of footer text
        columnsep = .33in, % Space between columns
      }

    % Set paragraph and line spacing
    \setlength {\parindent}            {1em}
    \setlength {\RaggedRightRightskip} {0pt plus 1em}
    \setlength {\RaggedRightParindent} {\parindent}

    % Restrict hyphenation
    \tolerance        = 1
    \emergencystretch = \maxdimen
    \hyphenpenalty    = 10000
    \hbadness         = 10000

    % Set left justification if not justified
    \bool_if:NF \l__dnd_justified_bool
      { \RaggedRight }

    % Customize itemize environment.
    \setlist{leftmargin=1em}
    \setitemize{noitemsep,topsep=0.5ex,label=\footnotesize{\textbullet}}
  }

%% Load other modules of this package after all dependencies to avoid load order
%% conflicts (e.g., package options).
%% Low-level modules first.
\RequirePackage {lib/compat}        % compatibility definitions
\RequirePackage {lib/dndutility}    % utility functions
\RequirePackage {lib/dndcolors}     % color definitions
\RequirePackage {lib/dndfonts}      % font definitions
\RequirePackage {lib/dndstrings}    % Load document strings

%% Conditionally load deprecated code for backwards compatibility
\bool_if:NF \l__dnd_no_deprecated_code_bool
  { \RequirePackage {lib/dnddeprecated} }

%% Main modules in alphabetical order
\RequirePackage {lib/dndcomment}    % inline comment boxes
\RequirePackage {lib/dndheader}     % fancy headers and footers
\RequirePackage {lib/dndmonster}    % stat blocks
\RequirePackage {lib/dndreadaloud}  % read-aloud text
\RequirePackage {lib/dndsections}   % section styling and special section headers
\RequirePackage {lib/dndsidebar}    % sidebars
\RequirePackage {lib/dndtable}      % tables
\RequirePackage {lib/dndtoc}        % table of contents styling
%</dndcore>
%<*dnd>
\RequirePackage {expl3}
\ProvidesExplPackage {dnd} {2020/04/21} {0.8.0} { Template for DnD 5e material }

\bool_new:N \c__dnd_isclass_bool

\input {dndoptions.clo}
\input {dndcore.def}
%</dnd>
%<*example>
\documentclass[letterpaper,twocolumn,openany,nodeprecatedcode]{dndbook}

%% Use babel or polyglossia to automatically redefine macros for terms
%% Armor Class, Level, etc...
%% Default output is in English; captions are located in lib/dndstrings.sty.
%% If no captions exist for a language, English will be used.
%%1. To load a language with babel:
%%	\usepackage[<lang>]{babel}
%%2. To load a language with polyglossia:
%%	\usepackage{polyglossia}
%%	\setdefaultlanguage{<lang>}
\usepackage[english]{babel}
%%\usepackage[italian]{babel}
%% For further options (multilanguage documents, hypenations, language environments...)
%% please refer to babel/polyglossia's documentation.

\usepackage[utf8]{inputenc}
\usepackage[singlelinecheck=false]{caption}
\usepackage{lipsum}
\usepackage{listings}
\usepackage{shortvrb}
\usepackage{stfloats}

\captionsetup[table]{labelformat=empty,font={sf,sc,bf,},skip=0pt}

\MakeShortVerb{|}

\lstset{%
  basicstyle=\ttfamily,
  language=[LaTeX]{TeX},
  breaklines=true,
}

\title{The Dark \LaTeX{} \\
\large An Example of the dndbook Class}
\author{The rpgTeX Team}
\date{2020/04/21}

\begin{document}

\frontmatter

\maketitle

\tableofcontents

\mainmatter%

\part{Layout}

\chapter{Sections}

\DndDropCapLine{T}{his package is designed to aid you in} writing beautifully typeset documents for the fifth edition of the world's greatest roleplaying game. It starts by adjusting the section formatting from the defaults in \LaTeX{} to something a bit more familiar to the reader. The chapter formatting is displayed above.

\section{Section}
Sections break up chapters into large groups of associated text.

\subsection{Subsection}
Subsections further break down the information for the reader.

\subsubsection{Subsubsection}
Subsubsections are the furthest division of text that still have a block header. Below this level, headers are displayed inline.

\paragraph{Paragraph}
The paragraph format is seldom used in the core books, but is available if you prefer it to the ``normal'' style.

\subparagraph{Subparagraph}
The subparagraph format with the paragraph indent is likely going to be more familiar to the reader.

\section{Special Sections}
The module also includes functions to aid in the proper typesetting of multi-line section headers: |\DndFeatHeader| for feats, |\DndItemHeader| magic items and traps, and |\DndSpellHeader| for spells.

\DndFeatHeader{Typesetting Savant}[Prerequisite: \LaTeX{} distribution]
You have acquired a package which aids in typesetting source material for one of your favorite games, giving you the following benefits:

\begin{itemize}
  \item You have advantage on Intelligence checks to typeset new content.
  \item When you fail an Intelligence check to typeset new content, you can ask questions online at the package's website.
\end{itemize}

\DndItemHeader{Foo's Quill}{Wondrous item, rare}
This quill has 3 charges. While holding it, you can use an action to expend 1 of its charges. The quill leaps from your hand and writes a contract applicable to your situation.

The quill regains 1d3 expended charges daily at dawn.

\DndSpellHeader%
  {Beautiful Typesetting}
  {4th-level illusion}
  {1 action}
  {5 feet}
  {S, M (ink and parchment, which the spell consumes)}
  {Until dispelled}
You are able to transform a written message of any length into a beautiful scroll. All creatures within range that can see the scroll must make a wisdom saving throw or be charmed by you until the spell ends.

While the creature is charmed by you, they cannot take their eyes off the scroll and cannot willingly move away from the scroll. Also, the targets can make a wisdom saving throw at the end of each of their turns. On a success, they are no longer charmed.

\section{Map Regions}
The map region functions |\DndArea| and |\DndSubArea| provide automatic numbering of areas.

\DndArea{Village of Hommlet}
This is the village of hommlet.

\DndSubArea{Inn of the Welcome Wench}
Inside the village is the inn of the Welcome Wench.

\DndSubArea{Blacksmith's Forge}
There's a blacksmith in town, too.

\DndArea{Foo's Castle}
This is foo's home, a hovel of mud and sticks.

\DndSubArea{Moat}
This ditch has a board spanning it.

\DndSubArea{Entrance}
A five-foot hole reveals the dirt floor illuminated by a hole in the roof.

\chapter{Text Boxes}

The module has three environments for setting text apart so that it is drawn to the reader's attention. |DndReadAloud| is used for text that a game master would read aloud.

\begin{DndReadAloud}
  As you approach this module you get a sense that the blood and tears of many generations went into its making. A warm feeling welcomes you as you type your first words.
\end{DndReadAloud}

\section{As an Aside}
The other two environments are the |DndComment| and the |DndSidebar|. The |DndComment| is breakable and can safely be used inline in the text.

\begin{DndComment}{This Is a Comment Box!}
  A |DndComment| is a box for minimal highlighting of text. It lacks the ornamentation of |DndSidebar|, but it can handle being broken over a column.
\end{DndComment}

The |DndSidebar| is not breakable and is best used floated toward a page corner as it is below.

\begin{DndSidebar}[float=!b]{Behold the DndSidebar!}
  The |DndSidebar| is used as a sidebar. It does not break over columns and is best used with a figure environment to float it to one corner of the page where the surrounding text can then flow around it.
\end{DndSidebar}

\section{Tables}
The |DndTable| colors the even rows and is set to the width of a line by default.

\begin{DndTable}[header=Nice Table]{XX}
    \textbf{Table head}  & \textbf{Table head} \\
    Some value  & Some value \\
    Some value  & Some value \\
    Some value  & Some value
\end{DndTable}

\chapter{Monsters and NPCs}

%% Monster stat block
\begin{DndMonster}[float*=b,width=\textwidth + 8pt]{Monster Foo}
  \begin{multicols}{2}
    \DndMonsterType{Medium aberration (metasyntactic variable), neutral evil}

    % If you want to use commas in the key values, enclose the values in braces.
    \DndMonsterBasics[
        armor-class = {9 (12 with \emph{mage armor})},
        hit-points  = {\DndDice{3d8 + 3}},
        speed       = {30 ft., fly 30 ft.},
      ]

    \DndMonsterAbilityScores[
        str = 12,
        dex = 8,
        con = 13,
        int = 10,
        wis = 14,
        cha = 15,
      ]

    \DndMonsterDetails[
        %saving-throws = {Str +0, Dex +0, Con +0, Int +0, Wis +0, Cha +0},
        %skills = {Acrobatics +0, Animal Handling +0, Arcana +0, Athletics +0, Deception +0, History +0, Insight +0, Intimidation +0, Investigation +0, Medicine +0, Nature +0, Perception +0, Performance +0, Persuasion +0, Religion +0, Sleight of Hand +0, Stealth +0, Survival +0},
        %damage-vulnerabilities = {cold},
        %damage-resistances = {bludgeoning, piercing, and slashing from nonmagical attacks},
        %damage-immunities = {poison},
        %condition-immunities = {poisoned},
        senses = {darkvision 60 ft., passive Perception 10},
        languages = {Common, Goblin, Undercommon},
        challenge = 1,
      ]
    % Traits
    \DndMonsterAction{Innate Spellcasting}
    Foo's spellcasting ability is Charisma (spell save DC 12, +4 to hit with spell attacks). It can innately cast the following spells, requiring no material components:
    \begin{DndMonsterSpells}
      \DndInnateSpellLevel{misty step}
      \DndInnateSpellLevel[3]{fog cloud, rope trick}
      \DndInnateSpellLevel[1]{identify}
    \end{DndMonsterSpells}

    \DndMonsterAction{Spellcasting}
    Foo is a 2nd-level spellcaster. Its spellcasting ability is Charisma (spell save DC 12, +4 to hit with spell attacks). It has the following sorcerer spells prepared:
    \begin{DndMonsterSpells}
      \DndMonsterSpellLevel{blade ward, fire bolt, light, shocking grasp}
      \DndMonsterSpellLevel[1][3]{burning hands, mage armor, shield}
    \end{DndMonsterSpells}

    \DndMonsterSection{Actions}
    \DndMonsterAction{Multiattack}
    The foo makes two melee attacks.

    %Default values are shown commented out
    \DndMonsterAttack[
      name=Dagger,
      %distance=both, % valid options are in the set {both,melee,ranged},
      %type=weapon, %valid options are in the set {weapon,spell}
      mod=+3,
      %reach=5,
      %range=20/60,
      %targets=one target,
      dmg=\DndDice{1d4+1},
      dmg-type=piercing,
      %plus-dmg=,
      %plus-dmg-type=,
      %or-dmg=,
      %or-dmg-when=,
      %extra=,
    ]

    %\DndMonsterMelee calls \DndMonsterAttack with the melee option
    \DndMonsterMelee[
      name=Flame Tongue Longsword,
      mod=+3,
      %reach=5,
      %targets=one target,
      dmg=\DndDice{1d8+1},
      dmg-type=slashing,
      plus-dmg=\DndDice{2d6},
      plus-dmg-type=fire,
      or-dmg=\DndDice{1d10+1},
      or-dmg-when=if used with two hands,
      %extra=,
    ]

    %\DndMonsterRanged calls \DndMonsterAttack with the ranged option
    \DndMonsterRanged[
      name=Assassin's Light Crossbow,
      mod=+1,
      range=80/320,
      dmg=\DndDice{1d8},
      dmg-type=piercing,
      %plus-dmg=,
      %plus-dmg-type=,
      %or-dmg=,
      %or-dmg-when=,
      extra={, and the target must make a DC 15 Constitution saving throw, taking 24 (7d6) poison damage on a failed save, or half as much damage on a successful one}
    ]

    % Legendary Actions
    \DndMonsterSection{Legendary Actions}
    The foo can take 3 legendary actions, choosing from the options below. Only one legendary action option can be used at a time and only at the end of another creature's turn. The foo regains spent legendary actions at the start of its turn.

    \begin{DndMonsterLegendaryActions}
      \DndMonsterLegendaryAction{Move}{The foo moves up to its speed.}
      \DndMonsterLegendaryAction{Dagger Attack}{The foo makes a dagger attack.}
      \DndMonsterLegendaryAction{Create Contract (Costs 3 Actions)}{The foo presents a contract in a language it knows and waves it in the face of a creature within 10 feet. The creature must make a DC 10 Intelligence saving throw. On a failure, the creature is incapacitated until the start of the foo's next turn. A creature who cannot read the language in which the contract is written has advantage on this saving throw.}
    \end{DndMonsterLegendaryActions}
  \end{multicols}
\end{DndMonster}

The |DndMonster| environment is used to typeset monster and NPC stat blocks. The module supplies many functions to easily typeset the contents of the stat block

\part{Customization}

\chapter{Colors}

\begin{table*}[b]
  \caption{\DndFontTableTitle{}Colors Supported by this Package}\label{tab:colors}

  \begin{tabularx}{\linewidth}{lX}
    \textbf{Color}                  & \textbf{Description} \\
    \rowcolor{PhbLightGreen}
    |PhbLightGreen|                 & Light green used in PHB Part 1 (Default) \\
    \rowcolor{PhbLightCyan}
    |PhbLightCyan|                  & Light cyan used in PHB Part 2 \\
    \rowcolor{PhbMauve}
    |PhbMauve|                      & Pale purple used in PHB Part 3 \\
    \rowcolor{PhbTan}
    |PhbTan|                        & Light brown used in PHB appendix \\
    \rowcolor{DmgLavender}
    |DmgLavender|                   & Pale purple used in DMG Part 1 \\
    \rowcolor{DmgCoral}
    |DmgCoral|                      & Orange-pink used in DMG Part 2 \\
    \rowcolor{DmgSlateGray}
    |DmgSlateGray| (|DmgSlateGrey|) & Blue-gray used in PHB Part 3 \\
    \rowcolor{DmgLilac}
    |DmgLilac|                      & Purple-gray used in DMG appendix \\
    \rowcolor{BrGreen}
    |BrGreen|                       & Gray-green used for tables in Basic Rules\\
  \end{tabularx}
\end{table*}

This package provides several global color variables to style |DndComment|, |DndReadAloud|, |DndSidebar|, and |DndTable| environments.

\begin{DndTable}[header=Box Colors]{lX}
  \textbf{Color}   & \textbf{Description} \\
  |commentcolor|   & |DndComment| background \\
  |readaloudcolor| & |DndReadAloud| background \\
  |sidebarcolor|   & |DndSidebar| background \\
  |tablecolor|     & background of even |DndTable| rows \\
\end{DndTable}

They also accept an optional color argument to set the color for a single instance. See Table~\ref{tab:colors} for a list of core book accent colors.

\begin{lstlisting}
\begin{DndTable}[color=PhbLightCyan]{cX}
  \textbf{d8} & \textbf{Item} \\
  1 & Small wooden button \\
  2 & Red feather \\
  3 & Human tooth \\
  4 & Vial of green liquid \\
  6 & Tasty biscuit \\
  7 & Broken axe handle \\
  8 & Tarnished silver locket \\
\end{DndTable}
\end{lstlisting}

\begin{DndTable}[color=PhbLightCyan]{cX}
  \textbf{d8} & \textbf{Item} \\
  1 & Small wooden button \\
  2 & Red feather \\
  3 & Human tooth \\
  4 & Vial of green liquid \\
  6 & Tasty biscuit \\
  7 & Broken axe handle \\
  8 & Tarnished silver locket \\
\end{DndTable}

\section{Themed Colors}
Use |\DndSetThemeColor[<color>]| to set |commentcolor|, |readaloudcolor|, |sidebarcolor|, and |tablecolor| to a specific color. Calling |\DndSetThemeColor| without an argument sets those colors to the current |themecolor|. In the following example the group limits the change to just a few boxes; after the group finishes, the colors are reverted to what they were before the group started.

\begin{lstlisting}
\begingroup
\DndSetThemeColor[PhbMauve]

\begin{DndComment}{This Comment Is in Mauve}
  This comment is in the the new color.
\end{DndComment}

\begin{DndSidebar}{This Sidebar Is Also Mauve}
  The sidebar is also using the new theme color.
\end{DndSidebar}
\endgroup
\end{lstlisting}

\begingroup
\DndSetThemeColor[PhbMauve]

\begin{DndComment}{This Comment Is in Mauve}
  This comment is in the the new color.
\end{DndComment}

\begin{DndSidebar}{This Sidebar Is Also Mauve}
  The sidebar is also using the new theme color.
\end{DndSidebar}
\endgroup

\end{document}
%</example>
%<*dndbook>
\RequirePackage {expl3}
\ProvidesExplClass {dndbook} {2020/04/21} {0.8.0} { Template for DnD 5e material }

\bool_new:N \c__dnd_isclass_bool
\bool_set_true:N \c__dnd_isclass_bool

\input {dndoptions.clo}

\LoadClass {book}

\input {dndcore.def}
%</dndbook>
%<*ngerman>
\ExplSyntaxOn % Use tilde (~) for spaces.

%% German captions
\addto\captionsngerman
  {
    \renewcommand\armorclassname{Rüstungsklasse}
    \renewcommand\hitpointsname{Trefferpunkte}
    \renewcommand\speedname{Bewegungsrate}
    \renewcommand\strstatname{STR}
    \renewcommand\dexstatname{GES}
    \renewcommand\constatname{KON}
    \renewcommand\intstatname{INT}
    \renewcommand\wisstatname{WEI}
    \renewcommand\chastatname{CHA}
    \renewcommand\skillsname{Fertigkeiten}
    \renewcommand\dimmname{Schadensimmunitäten}
    \renewcommand\dvulname{Schadensanfälligkeiten}
    \renewcommand\dresname{Schadensresistenzen}
    \renewcommand\cimmname{Zustandsimmunitäten}
    \renewcommand\savesname{Rettungswürfe}
    \renewcommand\sensesname{Sinne}
    \renewcommand\languagesname{Sprachen}
    \renewcommand\challengename{Herausforderungsgrad}
    \renewcommand\xpname{EP}
    % Monster attack
    \renewcommand\unitsname{m}
    \renewcommand\meleeattackname{Nahkampf-Waffenangriff}
    \renewcommand\rangedattackname{Fernkampf-Waffenangriff}
    \renewcommand\meleeorrangedattackname{Nah-~oder~Fernkampf-Waffenangriff}
    \renewcommand\orname{oder}
    \renewcommand\tohitname{|1|~zum~Treffen}
    \renewcommand\defaulttargetsname{ein~Ziel}
    \renewcommand\reachname{Reichweite}
    \renewcommand\rangename{Reichweite}
    \renewcommand\hitname{Treffer}
    \renewcommand\damagename{Schaden}
    \renewcommand\plusname{plus}
    % Spell levels
    \renewcommand\spellcantripsname{Zaubertricks}
    \renewcommand\spellfirstlevelname{1.~Grad}
    \renewcommand\spellsecondlevelname{2.~Grad}
    \renewcommand\spellthirdlevelname{3.~Grad}
    \renewcommand\spellfourthlevelname{4.~Grad}
    \renewcommand\spellfifthlevelname{5.~Grad}
    \renewcommand\spellsixthlevelname{6.~Grad}
    \renewcommand\spellseventhlevelname{7.~Grad}
    \renewcommand\spelleighthlevelname{8.~Grad}
    \renewcommand\spellninthlevelname{9.~Grad}
    % Spell slots
    \renewcommand\spellatwillname{beliebig oft}
    \renewcommand\spelloneslotname{1~Platz}
    \renewcommand\spelltwoslotsname{2~Plätze}
    \renewcommand\spellthreeslotsname{3~Plätze}
    \renewcommand\spellfourslotsname{4~Plätze}
    % Innate spellcasting
    \renewcommand\innateatwillname{Willentlich}
    \renewcommand\numberperdayname{|1|/Tag}
    \renewcommand\numberperdayeachname{jeweils~|1|/Tag}
    % Spell header
    \renewcommand\spellcastingtimename{Zeitaufwand}
    \renewcommand\spellrangename{Reichweite}
    \renewcommand\spellcomponentsname{Komponenten}
    \renewcommand\spelldurationname{Wirkungsdauer}
    % Miscellaneous
%%    \renewcommand\pageabbreviationname{pg.}
    \renewcommand\dname{W}
%%    \newcommand\tocchapterabbreviationname{Ch.}
  }
%</ngerman>
%<*spanish>
\ExplSyntaxOn % Use tilde (~) for spaces.

\addto\captionsspanish
  {
    % Monster basics
    \renewcommand\armorclassname{Clase~de~Armadura}
    \renewcommand\hitpointsname{Puntos~de~Golpe}
    \renewcommand\speedname{Velocidad}
    % Monster ability scores
    \renewcommand\strstatname{FUE}
    \renewcommand\dexstatname{DES}
    \renewcommand\constatname{CON}
    \renewcommand\intstatname{INT}
    \renewcommand\wisstatname{SAB}
    \renewcommand\chastatname{CAR}
    % Monster details
    \renewcommand\skillsname{Habilidades}
    \renewcommand\dimmname{Inmunidades~al~daño}
    \renewcommand\dvulname{Vulnerabilidades~al~daño}
    \renewcommand\dresname{Resistencias~al~daño}
    \renewcommand\cimmname{Inmunidades~a~condición}
    \renewcommand\savesname{Tiradas~de~salvación}
    \renewcommand\sensesname{Sentidos}
    \renewcommand\languagesname{Idiomas}
    \renewcommand\challengename{Desafío}
    \renewcommand\xpname{PE}
    % Monster attack
    \renewcommand\unitsname{pies}
    \renewcommand\meleeattackname{Ataque~de~arma~cuerpo~a~cuerpo}
    \renewcommand\rangedattackname{Ataque~de~arma~a~distancia}
    \renewcommand\meleeorrangedattackname{Ataque~de~arma~cuerpo~a~cuerpo~o~a~distancia}
    \renewcommand\orname{o}
    \renewcommand\tohitname{para~golpear}
    \renewcommand\defaulttargetsname{un~objetivo}
    \renewcommand\reachname{alcance}
    \renewcommand\rangename{alcance}
    \renewcommand\hitname{Impacto}
    \renewcommand\damagename{daño}
    \renewcommand\plusname{+}
    % Spell levels
    \renewcommand\spellcantripsname{Trucos}
    \renewcommand\spellfirstlevelname{Nivel~1}
    \renewcommand\spellsecondlevelname{Nivel~2}
    \renewcommand\spellthirdlevelname{Nivel~3}
    \renewcommand\spellfourthlevelname{Nivel~4}
    \renewcommand\spellfifthlevelname{Nivel~5}
    \renewcommand\spellsixthlevelname{Nivel~6}
    \renewcommand\spellseventhlevelname{Nivel~7}
    \renewcommand\spelleighthlevelname{Nivel~8}
    \renewcommand\spellninthlevelname{Nivel~9}
    % Spell slots
    \renewcommand\spellatwillname{a~voluntad}
    \renewcommand\spelloneslotname{1~espacio}
    \renewcommand\spelltwoslotsname{2~espacios}
    \renewcommand\spellthreeslotsname{3~espacios}
    \renewcommand\spellfourslotsname{4~espacios}
    % Innate spellcasting
    \renewcommand\innateatwillname{A~voluntad}
    \renewcommand\numberperdayname{|1|~al~día}
    \renewcommand\numberperdayeachname{|1|~al~día~cada~uno}
    % Spell header
    \renewcommand\spellcastingtimename{Tiempo~de~lanzamiento}
    \renewcommand\spellrangename{Alcance}
    \renewcommand\spellcomponentsname{Componentes}
    \renewcommand\spelldurationname{Duración}
    % Miscellaneous
    \renewcommand\dname{d}
%%    \renewcommand\pageabbreviationname{pg.}
  }

%</spanish>
%<*_template>
\ExplSyntaxOn % Use tilde (~) for spaces.

\addto\captions<language> % Replace <language> tag with your language
  {
    % Monster basics
    \renewcommand\armorclassname{Armor~Class}
    \renewcommand\hitpointsname{Hit~Points}
    \renewcommand\speedname{Speed}
    % Monster ability scores
    \renewcommand\strstatname{STR}
    \renewcommand\dexstatname{DEX}
    \renewcommand\constatname{CON}
    \renewcommand\intstatname{INT}
    \renewcommand\wisstatname{WIS}
    \renewcommand\chastatname{CHA}
    % Monster details
    \renewcommand\skillsname{Skills}
    \renewcommand\dimmname{Damage~Immunities}
    \renewcommand\dvulname{Damage~Vulnerabilities}
    \renewcommand\dresname{Damage~Resistances}
    \renewcommand\cimmname{Condition~Immunities}
    \renewcommand\savesname{Saving~Throws}
    \renewcommand\sensesname{Senses}
    \renewcommand\defaultsensesname{passive~Perception~10}
    \renewcommand\languagesname{Languages}
    \renewcommand\challengename{Challenge}
    \renewcommand\xpname{XP}
    % Monster attack
    \renewcommand\unitsname{ft.}
    \renewcommand\weaponname{Weapon}
    \renewcommand\spellname{Spell}
    \renewcommand\meleeattackname{Melee~|1|~Attack}
    \renewcommand\rangedattackname{Ranged~|1|~Attack}
    \renewcommand\meleeorrangedattackname{Melee~or~Ranged~|1|~Attack}
    \renewcommand\orname{or}
    \renewcommand\tohitname{|1|~to~hit}
    \renewcommand\defaulttargetsname{one~target}
    \renewcommand\reachname{reach}
    \renewcommand\rangename{range}
    \renewcommand\hitname{Hit}
    \renewcommand\damagename{damage}
    \renewcommand\plusname{plus}
    % Spell levels
    \renewcommand\spellcantripsname{Cantrips}
    \renewcommand\spellfirstlevelname{1st~level}
    \renewcommand\spellsecondlevelname{2nd~level}
    \renewcommand\spellthirdlevelname{3rd~level}
    \renewcommand\spellfourthlevelname{4th~level}
    \renewcommand\spellfifthlevelname{5th~level}
    \renewcommand\spellsixthlevelname{6th~level}
    \renewcommand\spellseventhlevelname{7th~level}
    \renewcommand\spelleighthlevelname{8th~level}
    \renewcommand\spellninthlevelname{9th~level}
    % Spell slots
    \renewcommand\spellatwillname{at~will}
    \renewcommand\spelloneslotname{1~slot}
    \renewcommand\spelltwoslotsname{2~slots}
    \renewcommand\spellthreeslotsname{3~slots}
    \renewcommand\spellfourslotsname{4~slots}
    % Innate spellcasting
    \renewcommand\innateatwillname{At~will}
    \renewcommand\numberperdayname{|1|/day}
    \renewcommand\numberperdayeachname{|1|/day~each}
%%    % Spell header
    \renewcommand\spellcastingtimename{Casting~Time}
    \renewcommand\spellrangename{Range}
    \renewcommand\spellcomponentsname{Components}
    \renewcommand\spelldurationname{Duration}
%%    % Miscellaneous
    \renewcommand\pageabbreviationname{pg.}
    \renewcommand\dname{d}
  }
%</_template>
%<*italian>
\ExplSyntaxOn
%% Use tilde (~) for spaces.

%% Italian captions
\addto\captionsitalian
  {
    % Monster basics
    \renewcommand\armorclassname{Classe~Armatura}
    \renewcommand\hitpointsname{Punti~Ferita}
    \renewcommand\speedname{Velocit\`a}
    % Monster ability scores
    \renewcommand\strstatname{FOR}
    \renewcommand\dexstatname{DES}
    \renewcommand\constatname{COS}
    \renewcommand\intstatname{INT}
    \renewcommand\wisstatname{SAG}
    \renewcommand\chastatname{CAR}
    % Monster details
    \renewcommand\skillsname{Abilit\`a}
    \renewcommand\dimmname{Immunità~Danni}
    \renewcommand\dvulname{Debolezze~Danni}
    \renewcommand\dresname{Resistenze~Danni}
    \renewcommand\cimmname{Immunit\`a~Condizioni}
    \renewcommand\savesname{Tiri~Salvezza}
    \renewcommand\sensesname{Sensi}
%%    \renewcommand\defaultsensesname{passive~Perception~10}
    \renewcommand\languagesname{Linguaggi}
    \renewcommand\challengename{Sfida}
    \renewcommand\xpname{PE}
    % Monster attack
    \renewcommand\unitsname{m.}
    \renewcommand\weaponname{Arma}
    \renewcommand\spellname{Sillabare}
    \renewcommand\meleeattackname{Attacco~con~|1|~da~Mischia}
    \renewcommand\rangedattackname{Attacco~con~|1|~a~Distanza}
    \renewcommand\meleeorrangedattackname{Attacco~con~|1|~da~Mischia~o~a~Distanza}
    \renewcommand\orname{o}
    \renewcommand\tohitname{|1|~per~colpire}
%%    \renewcommand\defaulttargetsname{one~target}
    \renewcommand\reachname{portata}
    \renewcommand\rangename{gittata}
    \renewcommand\hitname{Colpito}
    \renewcommand\damagename{danno}
%%    \renewcommand\plusname{plus}
    % Spell levels
    \renewcommand\spellcantripsname{Trucchetti}
    \renewcommand\spellfirstlevelname{1\degree{}~livello}
    \renewcommand\spellsecondlevelname{2\degree{}~livello}
    \renewcommand\spellthirdlevelname{3\degree{}~livello}
    \renewcommand\spellfourthlevelname{4\degree{}~livello}
    \renewcommand\spellfifthlevelname{5\degree{}~livello}
    \renewcommand\spellsixthlevelname{6\degree{}~livello}
    \renewcommand\spellseventhlevelname{7\degree{}~livello}
    \renewcommand\spelleighthlevelname{8\degree{}~livello}
    \renewcommand\spellninthlevelname{9\degree{}~livello}
    % Spell slots
    \renewcommand\spellatwillname{a~volont\`a}
    \renewcommand\spelloneslotname{1~slot}
    \renewcommand\spelltwoslotsname{2~slot}
    \renewcommand\spellthreeslotsname{3~slot}
    \renewcommand\spellfourslotsname{4~slot}
    % Innate spellcasting
    \renewcommand\innateatwillname{A~volont\`a}
    \renewcommand\numberperdayname{|1|/giorno}
    \renewcommand\numberperdayeachname{|1|/g.~ciascuno}
    % Spell header
    \renewcommand\spellcastingtimename{Tempo~di~Lancio}
    \renewcommand\spellrangename{Gittata}
    \renewcommand\spellcomponentsname{Componenti}
    \renewcommand\spelldurationname{Durata}
    % Miscellaneous
%%    \renewcommand\pageabbreviationname{pg.}
%%    \renewcommand\dname{d}
%%    \newcommand\tocchapterabbreviationname{Ch.}
  }
%</italian>
%<*japanese>
\ExplSyntaxOn % Use tilde (~) for spaces.

%% Japanese captions
\addto\captionsjapanese
  {
    % Monster basics
    \renewcommand\armorclassname{AC：}
    \renewcommand\hitpointsname{hp：}
    \renewcommand\speedname{移動速度：}
    % Monster ability scores
    \renewcommand\strstatname{【筋】}
    \renewcommand\dexstatname{【敏】}
    \renewcommand\constatname{【耐】}
    \renewcommand\intstatname{【知】}
    \renewcommand\wisstatname{【判】}
    \renewcommand\chastatname{【魅】}
    % Monster details
    \renewcommand\skillsname{技能：}
    \renewcommand\dimmname{ダメージ完全耐性：}
    \renewcommand\dvulname{ダメージ脆弱性：}
    \renewcommand\dresname{ダメージ抵抗：}
    \renewcommand\cimmname{状態完全耐性：}
    \renewcommand\savesname{セーブ：}
    \renewcommand\sensesname{感覚：}
    \renewcommand\languagesname{言語：}
    \renewcommand\challengename{脅威度：}
    \renewcommand\xpname{XP}
    % Monster attack
    \renewcommand\unitsname{フィート}
    \renewcommand\meleeattackname{近接武器攻撃：}
    \renewcommand\rangedattackname{遠隔武器攻撃：}
    \renewcommand\meleeorrangedattackname{近接／遠隔武器攻撃：}
    \renewcommand\orname{または}
    \renewcommand\tohitname{攻撃|1|}
    \renewcommand\defaulttargetsname{目標１つ}
    \renewcommand\reachname{間合い}
    \renewcommand\rangename{射程}
    \renewcommand\hitname{ヒット：}
    \renewcommand\damagename{ダメージ}
    \renewcommand\plusname{および}
    % Spell levels
    \renewcommand\spellcantripsname{初級呪文}
    \renewcommand\spellfirstlevelname{１レベル}
    \renewcommand\spellsecondlevelname{２レベル}
    \renewcommand\spellthirdlevelname{３レベル}
    \renewcommand\spellfourthlevelname{４レベル}
    \renewcommand\spellfifthlevelname{５レベル}
    \renewcommand\spellsixthlevelname{６レベル}
    \renewcommand\spellseventhlevelname{７レベル}
    \renewcommand\spelleighthlevelname{８レベル}
    \renewcommand\spellninthlevelname{９レベル}
    % Spell slots
    \renewcommand\spellatwillname{無限回}
    \renewcommand\spelloneslotname{１スロット}
    \renewcommand\spelltwoslotsname{２スロット}
    \renewcommand\spellthreeslotsname{３スロット}
    \renewcommand\spellfourslotsname{４スロット}
    % Innate spellcasting
    \renewcommand\innateatwillname{無限回}
    \renewcommand\numberperdayname{|1|回／日}
    \renewcommand\numberperdayeachname{|1|回／日ずつ} % TODO: Confirm official translation
    % Spell header
    \renewcommand\spellcastingtimename{発動時間}
    \renewcommand\spellrangename{射程}
    \renewcommand\spellcomponentsname{構成要素}
    \renewcommand\spelldurationname{持続時間}
    % Miscellaneous
    \renewcommand\dname{d}
%%    \newcommand\tocchapterabbreviationname{Ch.}
  }
%</japanese>
%<*russian>
\ExplSyntaxOn % Use tilde (~) for spaces.

%% Russian captions
\addto\captionsrussian
  {
    % Monster basics
    \renewcommand\armorclassname{Класс~Доспехов}
    \renewcommand\hitpointsname{Хиты}
    \renewcommand\speedname{Скорость}
    % Monster ability scores
    \renewcommand\strstatname{СИЛ}
    \renewcommand\dexstatname{ЛОВ}
    \renewcommand\constatname{ТЕЛ}
    \renewcommand\intstatname{ИНТ}
    \renewcommand\wisstatname{МДР}
    \renewcommand\chastatname{ХАР}
    % Monster details
    \renewcommand\skillsname{Навыки}
    \renewcommand\dimmname{Иммунитет~к~урону}
    \renewcommand\dvulname{Уязвимость~к~урону}
    \renewcommand\dresname{Сопротивление~урону}
    \renewcommand\cimmname{Иммунитет~к~состояниям}
    \renewcommand\savesname{Спасброски}
%%    \renewcommand\defaultsensesname{passive~Perception~10}
    \renewcommand\sensesname{Чувства}
    \renewcommand\languagesname{Языки}
    \renewcommand\challengename{Опасность}
%%    \renewcommand\xpname{XP}
    % Monster attack
%%    \renewcommand\unitsname{ft.}
%%    \renewcommand\weaponname{Weapon}
%%    \renewcommand\spellname{Spell}
%%    \renewcommand\meleeattackname{Melee~|1|~Attack}
%%    \renewcommand\rangedattackname{Ranged~|1|~Attack}
%%    \renewcommand\meleeorrangedattackname{Melee~or~Ranged~|1|~Attack}
%%    \renewcommand\orname{or}
%%    \renewcommand\tohitname{|1|~to~hit}
%%    \renewcommand\defaulttargetsname{one~target}
%%    \renewcommand\reachname{reach}
%%    \renewcommand\rangename{range}
%%    \renewcommand\hitname{Hit}
%%    \renewcommand\damagename{damage}
%%    \renewcommand\plusname{plus}
    % Spell levels
%%    \renewcommand\spellcantripsname{Cantrips}
%%    \renewcommand\spellfirstlevelname{1st~level}
%%    \renewcommand\spellsecondlevelname{2nd~level}
%%    \renewcommand\spellthirdlevelname{3rd~level}
%%    \renewcommand\spellfourthlevelname{4th~level}
%%    \renewcommand\spellfifthlevelname{5th~level}
%%    \renewcommand\spellsixthlevelname{6th~level}
%%    \renewcommand\spellseventhlevelname{7th~level}
%%    \renewcommand\spelleighthlevelname{8th~level}
%%    \renewcommand\spellninthlevelname{9th~level}
    % Spell slots
%%    \renewcommand\spellatwillname{at~will}
%%    \renewcommand\spelloneslotname{1~slot}
%%    \renewcommand\spelltwoslotsname{2~slots}
%%    \renewcommand\spellthreeslotsname{3~slots}
%%    \renewcommand\spellfourslotsname{4~slots}
    % Innate spellcasting
%%    \renewcommand\innateatwillname{At~will}
%%    \renewcommand\numberperdayname{|1|/day}
%%    \renewcommand\numberperdayeachname{|1|/day~each}
%%    % Spell header
%%    \renewcommand\spellcastingtimename{Casting~Time}
%%    \renewcommand\spellrangename{Range}
%%    \renewcommand\spellcomponentsname{Components}
%%    \renewcommand\spelldurationname{Duration}
%%    % Miscellaneous
%%    \renewcommand\pageabbreviationname{pg.}
%%    \renewcommand\dname{d}
%%     \newcommand\tocchapterabbreviationname{Ch.}
  }
%</russian>
%<*dndstrings>
\ExplSyntaxOn % Use tilde (~) for spaces.

%% \addto\captions<language> cannot handle macros with parameters
%% We need to make our own parameters
%% |1| represents parameter 1

\cs_new_protected:Npn \__dnd_caption:nn #1#2
  {
    \group_begin:
      \str_set:Nx \l_tmpa_str { #1 }
      \str_set:Nx \l_tmpb_str { #2 }
      \exp_args:NNnx \str_replace_all:Nnn \l_tmpa_str { |1| } { #2 }
      \str_use:N \l_tmpa_str
    \group_end:
  }

%% Document-level version for backwards compatibility
\NewDocumentCommand{\DndCaption}{ m m }
  { \__dnd_caption:nn {#1} {#2} }

%% Define all strings as new macros instead of hardcoding them in the
%% TeX files. This then allows us to add captions for multilanguage support.

%% If you add or update a caption here, add it to languages/_template.sty
%% as well.

%% Monster
%% Basics
\newcommand\armorclassname{Armor~Class}
\newcommand\hitpointsname{Hit~Points}
\newcommand\speedname{Speed}

%% Ability Scores
\newcommand\strstatname{STR}
\newcommand\dexstatname{DEX}
\newcommand\constatname{CON}
\newcommand\intstatname{INT}
\newcommand\wisstatname{WIS}
\newcommand\chastatname{CHA}

%% Details
\newcommand\skillsname{Skills}
\newcommand\dimmname{Damage~Immunities}
\newcommand\dvulname{Damage~Vulnerabilities}
\newcommand\dresname{Damage~Resistances}
\newcommand\cimmname{Condition~Immunities}
\newcommand\savesname{Saving~Throws}
\newcommand\sensesname{Senses}
\newcommand\defaultsensesname{passive~Perception~10}
\newcommand\languagesname{Languages}
\newcommand\challengename{Challenge}
\newcommand\xpname{XP}

%% Attacks
\newcommand\unitsname{ft.}
\newcommand\weaponname{Weapon}
\newcommand\spellname{Spell}
\newcommand\meleeattackname{Melee~|1|~Attack}
\newcommand\rangedattackname{Ranged~|1|~Attack}
\newcommand\meleeorrangedattackname{Melee~or~Ranged~|1|~Attack}
\newcommand\orname{or}
\newcommand\tohitname{|1|~to~hit}
\newcommand\defaulttargetsname{one~target}
\newcommand\reachname{reach}
\newcommand\rangename{range}
\newcommand\hitname{Hit}
\newcommand\damagename{damage}
\newcommand\plusname{plus}

%% Spell Levels
\newcommand\spellcantripsname{Cantrips}
\newcommand\spellfirstlevelname{1st~level}
\newcommand\spellsecondlevelname{2nd~level}
\newcommand\spellthirdlevelname{3rd~level}
\newcommand\spellfourthlevelname{4th~level}
\newcommand\spellfifthlevelname{5th~level}
\newcommand\spellsixthlevelname{6th~level}
\newcommand\spellseventhlevelname{7th~level}
\newcommand\spelleighthlevelname{8th~level}
\newcommand\spellninthlevelname{9th~level}

%% Spell Slots
\newcommand\spellatwillname{at~will}
\newcommand\spelloneslotname{1~slot}
\newcommand\spelltwoslotsname{2~slots}
\newcommand\spellthreeslotsname{3~slots}
\newcommand\spellfourslotsname{4~slots}

%% Innate spellcasting
\newcommand\innateatwillname{At~will}
\newcommand\numberperdayname{|1|/day}
\newcommand\numberperdayeachname{|1|/day~each}

%% Spell Header
\newcommand\spellcastingtimename{Casting~Time}
\newcommand\spellrangename{Range}
\newcommand\spellcomponentsname{Components}
\newcommand\spelldurationname{Duration}

%% Miscellaneous
\newcommand\pageabbreviationname{pg.}
\newcommand\dname{d}
\newcommand\tocchapterabbreviationname{Ch.}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Adding languages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% To add captions for other languages:
%% 1. Copy and paste languages/_template.sty to languages/<language>.sty
%% 2. Substitute the <language> token in the file with the language name
%%    (i.e. \addto\captionsfrench).
%% 3. Replace the English strings with the translations and comment any captions
%%    that you do not translate. Please keep the captions in the same order.
%% 4. Add \RequirePackage{lib/languages/<language>} to the following function.
\cs_new_protected_nopar:Npn \__dnd_input_languages:
  {
    \RequirePackage{lib/languages/italian}
    \RequirePackage{lib/languages/japanese} % Requires LuaTeX or XeTeX
    \RequirePackage{lib/languages/ngerman}
    \RequirePackage{lib/languages/russian}
    \RequirePackage{lib/languages/spanish}
}

%% Delay loading captions until after the user has imported a language package.
%% Enables using babel/polyglossia with the dndbook document class as well as the
%% dnd package.
%%
%% Both language packages use \AtBeginDocument. Use \AtEndPreamble (etoolbox)
%% instead to side-step load order issues.
\AtEndPreamble{
  % Check if either babel or polyglossia have been loaded,
  % in which case load the string captions
  \@ifpackageloaded{babel}{
    \__dnd_input_languages:
  }{}
  \@ifpackageloaded{polyglossia}{
    \__dnd_input_languages:
  }{}
}
%</dndstrings>
%<*dnddeprecated>
\RequirePackage {keycommand}

\ExplSyntaxOn
\NewDocumentCommand{\DndDeprecate}{ mmm }
  {
    \__dnd_deprecated:nnn {#1} {#2} {#3}
  }
\ExplSyntaxOff

%% Either hilariously, or infuriatingly, the \ifcommandkey
%% implementation is buggy. Here is a re-implementation
%% from tex.stackexchange.
\begingroup
  \makeatletter
  \catcode`\/=8 %
  \@firstofone
    {
      \endgroup
      \renewcommand{\ifcommandkey}[1]{%
        \csname @\expandafter \expandafter \expandafter
        \expandafter \expandafter \expandafter  \expandafter
        \kcmd@nbk \commandkey {#1}//{first}{second}//oftwo\endcsname
      }
  }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% dndcolors.sty - to be removed in version 1.0.0
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Sets the themecolor and colors for all themed elements
%% If called without the optional color, resets the color of all themed elements to the current themecolor
\newcommand{\setthemecolor}[1][themecolor]{%
  \DndDeprecate{\noexpand\setthemecolor}{1.0.0}{Use \noexpand\DndSetThemeColor to set the theme color.}%
  \colorlet{themecolor}{#1}
  \colorlet{commentcolor}{#1}
  \colorlet{sidebarcolor}{#1}
  \colorlet{tablecolor}{#1}
}

%% Backwards-compatible aliases and colours
\colorlet {commentgreen}  {PhbLightGreen}
\colorlet {itemtablepink} {DmgCoral}
\colorlet {monstertan}    {statblockbg}
\definecolor {monstertandark} {HTML} {F0DBB5}

%% Old interface
\colorlet {commentboxcolor} {commentcolor}
\colorlet {paperboxcolor}   {sidebarcolor}
\colorlet {quoteboxcolor}   {readaloudcolor}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% dndcomment.sty - to be removed in version 1.0.0
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%Usage \begin{commentbox}[options]{title}[color]
\ExplSyntaxOn
\DeclareTColorBox{commentbox}{O{} m O{commentboxcolor}}{%
  before~upper={%
    \bool_if:NT \l__dnd_layout_bool
      {
        \bool_if:NF \l__dnd_justified_bool
          { \RaggedRight }
      }
  },
  code={\DndDeprecate{\noexpand\commentbox}{1.0.0}{Use~\noexpand\DndComment~for~breakable~comment~boxes.}\linespread{.9}},
  frame~hidden,
  boxrule=0pt,
  breakable,
  enhanced,
  before~skip=13pt plus 4pt minus 4pt,
  toptitle=2pt,
  boxsep=3pt,
  left=6pt,
  right=6pt,
  top=0pt,
  bottom=2pt,
  sharp~corners,
  fonttitle=\DndFontCommentTitle,
  fontupper=\DndFontCommentBody,
  fontlower=\DndFontCommentBody,
  title={#2},
  parbox=false,
  colback=#3,
  colbacktitle=#3,
  coltitle=black,
  after~skip=13pt plus 4pt minus 4pt,
  #1
}
\ExplSyntaxOff

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% dndmonster.sty - to be removed in version 1.0.0
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Fancy DnD 5e stat block rule
\newcommand{\dndline}{%
  \DndDeprecate{\noexpand\dndline}{1.0.0}{Use \noexpand\DndMonsterLine for stat block rules.}%
  \noindent
  \begin{tikzpicture}[]
    \draw [rulered, fill=rulered] (0, 0) --(0,0.1) -- (\textwidth, 0.05);
  \end{tikzpicture}%
  \par%
}

\RequirePackage{fp}
\RequirePackage{xstring}

%% Macro to print stats with auto-computed modifier
%% e.g. \stat{12} prints "12 (+1)"
\newcommand{\stat}[1]{%
  \DndDeprecate{\noexpand\stat}{1.0.0}{Use \noexpand\DndMonsterAbilityScores for the stat block ability score table.}%
  \FPeval{\mod}{(#1 - 10)/2}%
  \FPifpos\mod%
  \FPeval{\mod}{clip(trunc(mod,0))}#1\ (+\mod)%
  \else%
  \FPeval{\mod}{clip(abs(trunc(mod-0.5,0)))}#1\ (--\mod)%
  \fi%
}

%% Macro to print avarage dice based value
%% e.g. \dice{2d6+3} prints "10 (2d6 + 3)"
\newcommand{\dice}[1]{%
  \DndDeprecate{\noexpand\dice}{1.0.0}{Use \noexpand\DndDice to typeset a dice roll with the average value.}%
  \StrSubstitute{#1}{ }{}[\DiceArg]%				strip whitespaces
  \StrCut{\DiceArg}{d}\DiceNum\DiceSides%			split string
  \StrCut{\DiceSides}{+}\DiceSides\DiceAddMod%
  \StrCut{\DiceSides}{-}\DiceSides\DiceSubMod%
  \FPeval{\DiceAvg}{(\DiceSides+1)/2*\DiceNum}%	calculate avg roll
  \IfInteger{\DiceAddMod}{%
    \FPadd{\DiceAvg}{\DiceAvg}{\DiceAddMod}%	add value
    \def\DiceMod{ + \DiceAddMod}%
  }{%
    \IfInteger{\DiceSubMod}{%
      \FPsub{\DiceAvg}{\DiceAvg}{\DiceSubMod}%	subtract value
      \def\DiceMod{ -- \DiceSubMod}%
    }{%
      \def\DiceMod{}%
    }%
  }%
  \FPtrunc{\DiceAvg}{\DiceAvg}{0}%				round down
  \FPprint{\DiceAvg\ (\DiceNum \dname\DiceSides\DiceMod)}%
}

%% Stat block without the background
\newtcolorbox{monsterboxnobg}[2][]{
  enhanced,
  code={\DndDeprecate{\noexpand\monsterboxnobg}{1.0.0}{Use \noexpand\DndMonsterNoBg for stat blocks without a background.}},
  frame hidden,
  boxrule=0pt,
  breakable,
  parbox=false,
  boxsep=0pt,
  toptitle=3mm,
  left=0pt,
  right=0pt,
  sharp corners,
  opacityback=0,
  colframe=titlered,
  fonttitle=\DndFontStatBlockTitle,
  fontupper=\DndFontStatBlockBody,
  fontlower=\DndFontStatBlockBody,
  title=#2,
  coltitle=titlered,
  #1
}

%% Stat block with background
\newtcolorbox{monsterboxbg}[2][]{
  enhanced,
  code={\DndDeprecate{\noexpand\monsterboxbg}{1.0.0}{Use \noexpand\DndMonsterBg for stat blocks with a background.}},
  frame hidden,
  before skip=12pt plus 3pt minus 3pt,
  boxrule=0pt,
  breakable,
  parbox=false,
  boxsep=2pt,
  toptitle=8pt,
  top=0pt,
  left=2pt,
  right=2pt,
  bottom=7pt,
  sharp corners,
  oversize=0pt,
  borderline north={3pt}{0pt}{titlered},
  borderline north={2pt}{0.5pt}{statblockribbon},
  borderline south={3pt}{0pt}{titlered},
  borderline south={2pt}{0.5pt}{statblockribbon},
  colback=statblockbg,
  colbacktitle=statblockbg,
  colframe=titlered,
  fonttitle=\DndFontStatBlockTitle,
  coltitle=titlered,
  fontupper=\DndFontStatBlockBody,
  fontlower=\DndFontStatBlockBody,
  title=#2,
  #1
}

\ExplSyntaxOn
\bool_if:NTF \l__dnd_show_background_bool
  {
    \let\monsterbox\monsterboxbg%
    \let\endmonsterbox\endmonsterboxbg%
  }
  {
    \let\monsterbox\monsterboxnobg%
    \let\endmonsterbox\endmonsterboxnobg%
  }

\ExplSyntaxOff

%% Define Monster subsection header style
\newcommand{\monstersection}[1]{%
  \DndDeprecate{\noexpand\monstersection}{1.0.0}{Use \noexpand\DndMonsterSection for stat blocks sections.}%
  \begingroup
    \par\medskip\noindent
    \DndFontStatBlockSection #1
    % \rule is a horizontal command, so placing it under the title incurs extra
    % line spacing. Use \hrule (a vertical command) instead.
    \vspace{3pt}
    \hrule height 0.6pt
    \vspace{2pt}
  \endgroup%
}

\NewDocumentEnvironment{monsteraction}{o}{%
  \DndDeprecate{\noexpand\monsteraction}{1.0.0}{Use \noexpand\DndMonsterAction for stat block actions.}%
  \IfValueTF{#1}{%
    \par\medskip\noindent\emph{\textbf{#1.}}%
  }{\unskip}%
}{\par}

%% A description variant used to list creature attributes.
\newlist{dnd@monsterattrs}{description}{1}

\ExplSyntaxOn

\setlist[dnd@monsterattrs]{
  before=\color{titlered},
  font=\DndFontStatBlockBody,
  labelsep=\l__dnd_space_dim,
  noitemsep,
  nosep,
}

\ExplSyntaxOff

%% A dnd@monsterattrs helper macro that always displays an attribute.
\newcommand{\dnd@monsterattr}[2]{%
  \item[#2] \commandkey{#1}
}

%% A dnd@monsterattrs helper macro that displays an attribute if the user defined
%% it.
\newcommand{\dnd@ifmonsterattr}[2]{%
  \ifcommandkey{#1}{%
    \item[#2] \commandkey{#1}
  }{}%
}

%%
%% Macros for use within the monster environment
%%
\newkeycommand\basics[armorclass=0, hitpoints=0, speed=0]{%
  \DndDeprecate{\noexpand\basics}{1.0.0}{Use \noexpand\DndMonsterBasics for stat block AC, HP, and speed.}%
  \begin{dnd@monsterattrs}
    \dnd@monsterattr{armorclass}{\armorclassname}
    \dnd@monsterattr{hitpoints}{\hitpointsname}
    \dnd@monsterattr{speed}{\speedname}
  \end{dnd@monsterattrs}%
}

%% Taubular enviornment for stats-block
\newkeycommand\stats[%
  STR=\stat{10},
  DEX=\stat{10},
  CON=\stat{10},
  INT=\stat{10},
  WIS=\stat{10},
  CHA=\stat{10}]{%
  \DndDeprecate{\noexpand\stats}{1.0.0}{Use \noexpand\DndMonsterAbilityScores for the stat block ability score table.}%
  \begingroup%
    \color{titlered}%
    \par\vspace{5pt}\noindent%
    \begin{tabularx}{\linewidth}{YYYYYY}
      \textbf{\strstatname} &
      \textbf{\dexstatname} &
      \textbf{\constatname} &
      \textbf{\intstatname} &
      \textbf{\wisstatname} &
      \textbf{\chastatname} \\
      \commandkey{STR} &
      \commandkey{DEX} &
      \commandkey{CON} &
      \commandkey{INT} &
      \commandkey{WIS} &
      \commandkey{CHA}
    \end{tabularx}%
    \par\vspace{4pt}%
  \endgroup%
}

\newkeycommand\details[
  skills=,
  damageimmunities=,
  savingthrows=,
  conditionimmunities=,
  damageresistances=,
  damagevulnerabilities=,
  senses=---,
  languages=---,
  challenge=1,
  ]{%
  \DndDeprecate{\noexpand\details}{1.0.0}{Use \noexpand\DndMonsterDetails for stat block details like resistances and CR.}%
  \begin{dnd@monsterattrs}
    \dnd@ifmonsterattr{savingthrows}{\savesname}
    \dnd@ifmonsterattr{skills}{\skillsname}
    \dnd@ifmonsterattr{damagevulnerabilities}{\dvulname}
    \dnd@ifmonsterattr{damageresistances}{\dresname}
    \dnd@ifmonsterattr{damageimmunities}{\dimmname}
    \dnd@ifmonsterattr{conditionimmunities}{\cimmname}
    \dnd@monsterattr{senses}{\sensesname}
    \dnd@monsterattr{languages}{\languagesname}
    \item[\challengename] \DndCRExp{\commandkey{challenge}}
  \end{dnd@monsterattrs}%
}

\ExplSyntaxOn
\newcommand{\dnd@hit}[1]{%
  \__dnd_caption:nn {\tohitname} {#1}
}
\ExplSyntaxOff

\newcommand{\dnd@damage}[2]{%
  \commandkey{#1}\ \commandkey{#2}\ \damagename%
}

\newcommand{\dnd@ifplusdmg}[2]{%
  \ifcommandkey{#1}{%
    { }\plusname\ \commandkey{#1}\ \commandkey{#2}\ \damagename%
  }{}%
}
\newcommand{\dnd@ifordmg}[5]{%
  \ifcommandkey{#1}{%
    , \orname\ \commandkey{#1}\ \commandkey{#2}\ \damagename\dnd@ifplusdmg{#4}{#5}\ \commandkey{#3}%
  }{}%
}

\newkeycommand+[\|]\monstermelee[
    name=Club,
    mod=+0,
    reach=5,
    targets=\defaulttargetsname,
    dmg=\dice{1d4},
    dmgtype=bludgeoning,
    plusdmg=,
    plusdmgtype=,
    ordmg=,
    ordmgwhen=,
    extra=,
  ]{%
  |\monsterattack|[
    name={\commandkey{name}},
    type=melee,
    mod={\commandkey{mod}},
    reach={\commandkey{reach}},
    targets={\commandkey{targets}},
    dmg={\commandkey{dmg}},
    dmgtype={\commandkey{dmgtype}},
    plusdmg={\commandkey{plusdmg}},
    plusdmgtype={\commandkey{plusdmgtype}},
    ordmg={\commandkey{ordmg}},
    ordmgwhen={\commandkey{ordmgwhen}},
    extra={\commandkey{extra}},
  ]
}
\newkeycommand+[\|]\monsterranged[
    name=Shortbow,
    mod=+0,
    range=80/320,
    targets=\defaulttargetsname,
    dmg=\dice{1d6},
    dmgtype=piercing,
    plusdmg=,
    plusdmgtype=,
    ordmg=,
    ordmgwhen=,
    extra=,
  ]{%
  |\monsterattack|[
    name={\commandkey{name}},
    type=ranged,
    mod={\commandkey{mod}},
    range={\commandkey{range}},
    targets={\commandkey{targets}},
    dmg={\commandkey{dmg}},
    dmgtype={\commandkey{dmgtype}},
    plusdmg={\commandkey{plusdmg}},
    plusdmgtype={\commandkey{plusdmgtype}},
    ordmg={\commandkey{ordmg}},
    ordmgwhen={\commandkey{ordmgwhen}},
    extra={\commandkey{extra}},
  ]
}

\newkeycommand\monsterattack[
    name=Dagger,
    enum* type={both,melee,ranged},
    mod=+0,
    reach=5,
    range=20/60,
    targets=\defaulttargetsname,
    dmg=\dice{1d4},
    dmgtype=piercing,
    plusdmg=,
    plusdmgtype=,
    ordmg=,
    ordmgwhen=,
    extra=,
  ]{%
  \DndDeprecate{\noexpand\monsterattack}{1.0.0}{Use \noexpand\DndMonsterMelee, \noexpand\DndMonsterRanged, or \noexpand\DndMonsterAttack for attacks that are melee, ranged, or both, respectively.}%
  \begin{monsteraction}[\commandkey{name}]
    \IfStrEqCase{\commandkey{type}}{%
      {melee}{\textit{\DndCaption{\meleeattackname}{\weaponname}:} \dnd@hit{mod}, \reachname\ \commandkey{reach} \unitsname}%
      {ranged}{\textit{\DndCaption{\rangedattackname}{\weaponname}:} \dnd@hit{mod}, \rangename\ \commandkey{range} \unitsname}%
      {both}{\textit{\DndCaption{\meleeorrangedattackname}{\weaponname}:} \dnd@hit{mod}, \reachname\ \commandkey{reach} \unitsname\ \orname\ \rangename\ \commandkey{range} \unitsname}%
    }[]%
    , \commandkey{targets}.
    \textit{\hitname:} \dnd@damage{dmg}{dmgtype}%
    \dnd@ifplusdmg{plusdmg}{plusdmgtype}%
    \dnd@ifordmg{ordmg}{dmgtype}{ordmgwhen}{plusdmg}{plusdmgtype}%
    \ifcommandkey{extra}{\commandkey{extra}}{}.
  \end{monsteraction}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% dndpaperbox.sty - to be removed in version 1.0.0
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%Usage \begin{paperbox}[options]{title}[color]
\ExplSyntaxOn
\DeclareTColorBox{paperbox}{O{} m O{paperboxcolor}}{%
  before~upper={%
    \bool_if:NT \l__dnd_layout_bool
      {
        \bool_if:NF \l__dnd_justified_bool
          {\RaggedRight}
      }
  },
  code={\DndDeprecate{\noexpand\paperbox}{1.0.0}{Use \noexpand\DndSidebar for sidebars.}\linespread{.9}},
  frame~hidden,
  boxrule=0pt,
  enhanced,
  before~skip=13pt plus 4pt minus 4pt,
  toptitle=2pt,
  boxsep=3pt,
  left=6pt,
  right=6pt,
  top=0pt,
  bottom=3pt,
  fonttitle=\DndFontSidebarTitle,
  fontupper=\DndFontSidebarBody,
  fontlower=\DndFontSidebarBody,
  title={#2},
  sharp~corners,
  parbox=false,
  borderline~north={1pt}{-0.5pt}{black},
  borderline~south={1pt}{-0.5pt}{black},
  colback=#3,
  colbacktitle=#3,
  coltitle=black,
  fuzzy~shadow={0mm}{-3.5pt}{-0.5pt}{0.4mm}{black!60!white},
  overlay={%
    \fill[black] (frame.south~west) -- ++ (7pt,0) -- ++ (0,-5pt) -- cycle;
    \fill[black] (frame.north~west) -- ++ (7pt,0) -- ++ (0,5pt) -- cycle;
    \fill[black] (frame.north~east) -- ++ (-7pt,0) -- ++ (0,5pt) -- cycle;
    \fill[black] (frame.south~east) -- ++ (-7pt,0) -- ++ (0,-5pt) -- cycle;
    },
  after~skip=14pt plus 4pt minus 4pt,
  #1
}
\ExplSyntaxOn

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% dndquote.sty - to be removed in version 1.0.0
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%Usage \begin{quotebox}[options][color]
\ExplSyntaxOn
\DeclareTColorBox{quotebox}{O{} O{quoteboxcolor}}{%
  before~upper={%
    \bool_if:NT \l__dnd_layout_bool
      {
        \bool_if:NF \l__dnd_justified_bool
          {\RaggedRight}
      }
  },
  code={\DndDeprecate{\noexpand\quotebox}{1.0.0}{Use~\noexpand\DndReadAloud~for~read-aloud~text.}\linespread{1.1}},
  enhanced~jigsaw,
  frame~hidden,
  boxrule=0pt,
  breakable,
  enhanced,
  before~skip=13pt plus 4pt minus 4pt,
  boxsep=8pt,
  top=0pt,
  left=0pt,
  right=0pt,
  bottom=0pt,
  colback=#2,
  sharp~corners,
  parbox=false,
  borderline~west={1pt}{-0.5pt}{titlered},
  borderline~east={1pt}{-0.5pt}{titlered},
  fontupper=\DndFontReadAloud,
  fontlower=\DndFontReadAloud,
  overlay={%
    \foreach\n in {north~east,north~west,south~east,south~west}
    {\draw[titlered, fill=titlered] (frame.\n) circle (1.5pt); }; },
  after~skip=13pt plus 4pt minus 4pt,
  #1
}
\ExplSyntaxOff

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% dndsections.sty - to be removed in version 1.0.0
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Special command for magic items, traps, and the like.
\newcommand{\subtitlesection}[2]{%
  \DndDeprecate{\noexpand\subtitlesection}{1.0.0}{Use \noexpand\DndItemHeader for item headers.}%
  \subsubsection{#1}%
  \textit{#2}
  \par\vspace{3pt plus 1pt minus 1pt}\noindent\ignorespaces}

%% Map Areas and their References

%% Labelling helpers
\newcommand{\AreaLabel@Prefix}{area}
\newcommand{\SetAreaLabelPrefix}[1]{%
\renewcommand{\AreaLabel@Prefix}{#1}}

\newcounter{Area}
\newcommand\ResetAreas{%
  \DndDeprecate{\noexpand\ResetAreas}{1.0.0}{Use \noexpand\DndResetAreas to reset area counters.}%
  \setcounter{Area}{0}
}

\NewDocumentCommand\area{mo}{%
  \DndDeprecate{\noexpand\area}{1.0.0}{Use \noexpand\DndArea to typeset a section with an area counter.}%
  \refstepcounter{Area}%
  \IfNoValueTF{#2}%
    {\label{\AreaLabel@Prefix:#1}}%
    {\label{\AreaLabel@Prefix:#2}}%
  \subsection{\arabic{Area}. #1}%
}

%% defines sub-areas, like '5a', '5b'
\newcounter{SubArea}[Area]

\NewDocumentCommand\subarea{mo}{%
  \DndDeprecate{\noexpand\subarea}{1.0.0}{Use \noexpand\DndSubArea to typeset a section with an sub-area counter.}%
  \refstepcounter{SubArea}%
  \IfNoValueTF{#2}%
    {\label{\AreaLabel@Prefix:#1}}%
    {\label{\AreaLabel@Prefix:#2}}%
  \subsubsection{\arabic{Area}\alph{SubArea}. #1}%
}

%% sub area references should be '5a', '5b', not '1', '2'
\renewcommand\p@SubArea{\arabic{Area}}
\renewcommand\theSubArea{\alph{SubArea}}

\newcounter{DetailArea}[subsection]
\newcommand{\DetailArea@Prefix}{}
\newcommand{\SetDetailAreaPrefix}[1]{\renewcommand{\DetailArea@Prefix}
      {#1--\arabic{DetailArea}\par\expandafter\ignorespaces\noindent}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% dndspell.sty - to be removed in version 1.0.0
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\spellheader}[6]{%
  \DndDeprecate{\noexpand\spellheader}{1.0.0}{Use \noexpand\DndSpellHeader to typeset a spell header.}%
  \subtitlesection{#1}{#2}
  \begin{description}[noitemsep,nosep,after=\smallskip,leftmargin=1em]
    \item[\spellcastingtimename:] #3
    \item[\spellrangename:] #4
    \item[\spellcomponentsname:] #5
    \item[\spelldurationname:] #6
  \end{description}
}

\newenvironment{spell}[6]
  {\spellheader{#1}{#2}{#3}{#4}{#5}{#6}}
  % Environment encloses description.
{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% dndtable.sty - to be removed in version 1.0.0
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Table Header
\newcommand{\header}[1]{%
\begingroup%
\par\vspace{10pt plus 3 pt minus 3pt}%
\noindent%
\DndFontTableTitle%
#1%
\endgroup%
}

%% Table Environment
\NewDocumentEnvironment{dndtable}{O{XX} O{tablecolor}}{%
  \DndDeprecate{\noexpand\dndtable}{1.0.0}{Use \noexpand\DndTable for tables.}%
  \par\vspace{2pt plus 1pt minus 1pt}%
  \noindent%
  \DndFontTableBody%
  \setlength{\extrarowheight}{3pt}%
  \rowcolors{1}{}{#2}%
  \tabularx{\linewidth}{#1}%
}{%
  \endtabularx%
  \par\vspace{10pt plus 3 pt minus 3pt}%
}
%</dnddeprecated>
%<*dndfonts>
\ExplSyntaxOn

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Font definitions
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{lettrine}
\RequirePackage{Royal}
\RequirePackage[auto]{contour}

\bool_if:NT \l__dnd_layout_bool
  {
    \RequirePackage{bookman}
    \RequirePackage[type1]{gillius2}
    \RequirePackage[notext,nomath,nott]{kpfonts}
    \RequirePackage[T1]{fontenc}
    \renewcommand{\sfdefault}{jkpss}
  }

\cs_new_protected:Npn \__dnd_sf_initial_family:
  {
    \bool_if:NTF \l__dnd_layout_bool
      { \gilliustwo }
      { \sffamily }
  }

\keys_define:nn { dnd / fonts }
  {
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Sectioning commands
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Part
    part-family .tl_set:N         = \l__dnd_part_family_tl,
    part-family .initial:n        = \normalfont,
    part-family .value_required:n = true,
    part-style .tl_set:N         = \l__dnd_part_style_tl,
    part-style .initial:n        = \color{titlered} \Huge \scshape,
    part-style .value_required:n = true,
    % Chapter
    chapter-family .tl_set:N         = \l__dnd_chapter_family_tl,
    chapter-family .initial:n        = \normalfont,
    chapter-family .value_required:n = true,
    chapter-style .tl_set:N         = \l__dnd_chapter_style_tl,
    chapter-style .initial:n        = \linespread{.9} \color{titlered} \Huge \scshape,
    chapter-style .value_required:n = true,
    % Section
    section-family .tl_set:N         = \l__dnd_section_family_tl,
    section-family .initial:n        = \normalfont,
    section-family .value_required:n = true,
    section-style .tl_set:N         = \l__dnd_section_style_tl,
    section-style .initial:n        = \linespread{.9} \color{titlered} \huge \scshape \RaggedRight,
    section-style .value_required:n = true,
    % Subsection
    subsection-family .tl_set:N         = \l__dnd_subsection_family_tl,
    subsection-family .initial:n        = \normalfont,
    subsection-family .value_required:n = true,
    subsection-style .tl_set:N         = \l__dnd_subsection_style_tl,
    subsection-style .initial:n        = \linespread{.9} \color{titlered} \Large \scshape \RaggedRight,
    subsection-style .value_required:n = true,
    % subsubsection
    subsubsection-family .tl_set:N         = \l__dnd_subsubsection_family_tl,
    subsubsection-family .initial:n        = \normalfont,
    subsubsection-family .value_required:n = true,
    subsubsection-style .tl_set:N         = \l__dnd_subsubsection_style_tl,
    subsubsection-style .initial:n        = \linespread{.9} \color{titlered} \large \scshape \RaggedRight,
    subsubsection-style .value_required:n = true,
    % paragraph
    paragraph-family .tl_set:N         = \l__dnd_paragraph_family_tl,
    paragraph-family .value_required:n = true,
    paragraph-style .tl_set:N         = \l__dnd_paragraph_style_tl,
    paragraph-style .initial:n        = \bfseries \slshape,
    paragraph-style .value_required:n = true,
    % subparagraph
    subparagraph-family .tl_set:N         = \l__dnd_subparagraph_family_tl,
    subparagraph-family .value_required:n = true,
    subparagraph-style .tl_set:N         = \l__dnd_subparagraph_style_tl,
    subparagraph-style .initial:n        = \bfseries \slshape,
    subparagraph-style .value_required:n = true,
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Tables
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Table title
    table-title-family .tl_set:N         = \l__dnd_table_title_family_tl,
    table-title-family .initial:n        = \sffamily,
    table-title-family .value_required:n = true,
    table-title-style .tl_set:N         = \l__dnd_table_title_style_tl,
    table-title-style .initial:n        = \bfseries \scshape \large,
    table-title-style .value_required:n = true,
    % Table body
    table-body-family .tl_set:N         = \l__dnd_table_body_family_tl,
    table-body-family .initial:n        = \__dnd_sf_initial_family:,
    table-body-family .value_required:n = true,
    table-body-style .tl_set:N         = \l__dnd_table_body_style_tl,
    table-body-style .initial:n        = \small,
    table-body-style .value_required:n = true,
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Comment boxes
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Comment title
    comment-title-family .tl_set:N         = \l__dnd_comment_title_family_tl,
    comment-title-family .initial:n        = \sffamily,
    comment-title-family .value_required:n = true,
    comment-title-style .tl_set:N         = \l__dnd_comment_title_style_tl,
    comment-title-style .initial:n        = \bfseries \scshape,
    comment-title-style .value_required:n = true,
    % Comment body
    comment-body-family .tl_set:N         = \l__dnd_comment_body_family_tl,
    comment-body-family .initial:n        = \__dnd_sf_initial_family:,
    comment-body-family .value_required:n = true,
    comment-body-style .tl_set:N         = \l__dnd_comment_body_style_tl,
    comment-body-style .initial:n        = \small,
    comment-body-style .value_required:n = true,
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Sidebars
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Sidebar title
    sidebar-title-family .tl_set:N         = \l__dnd_sidebar_title_family_tl,
    sidebar-title-family .initial:n        = \sffamily,
    sidebar-title-family .value_required:n = true,
    sidebar-title-style .tl_set:N         = \l__dnd_sidebar_title_style_tl,
    sidebar-title-style .initial:n        = \bfseries \scshape,
    sidebar-title-style .value_required:n = true,
    % Sidebar body
    sidebar-body-family .tl_set:N         = \l__dnd_sidebar_body_family_tl,
    sidebar-body-family .initial:n        = \__dnd_sf_initial_family:,
    sidebar-body-family .value_required:n = true,
    sidebar-body-style .tl_set:N         = \l__dnd_sidebar_body_style_tl,
    sidebar-body-style .initial:n        = \small,
    sidebar-body-style .value_required:n = true,
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Read-aloud boxes
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    readaloud-family .tl_set:N         = \l__dnd_readaloud_family_tl,
    readaloud-family .initial:n        = \__dnd_sf_initial_family:,
    readaloud-family .value_required:n = true,
    readaloud-style .tl_set:N         = \l__dnd_readaloud_style_tl,
    readaloud-style .initial:n        = \small,
    readaloud-style .value_required:n = true,
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Table of Contents
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Part
    toc-part-family .tl_set:N         = \l__dnd_toc_part_family_tl,
    toc-part-family .initial:n        = \normalfont,
    toc-part-family .value_required:n = true,
    toc-part-style .tl_set:N         = \l__dnd_toc_part_style_tl,
    toc-part-style .initial:n        = \Large \scshape \color{titlered},
    toc-part-style .value_required:n = true,
    % Chapter
    toc-chapter-family .tl_set:N         = \l__dnd_toc_chapter_family_tl,
    toc-chapter-family .initial:n        = \normalfont,
    toc-chapter-family .value_required:n = true,
    toc-chapter-style .tl_set:N         = \l__dnd_toc_chapter_style_tl,
    toc-chapter-style .initial:n        = \large \scshape \color{titlered},
    toc-chapter-style .value_required:n = true,
    % Section
    toc-section-family .tl_set:N         = \l__dnd_toc_section_family_tl,
    toc-section-family .initial:n        = \normalfont,
    toc-section-family .value_required:n = true,
    toc-section-style .tl_set:N         = \l__dnd_toc_section_style_tl,
    toc-section-style .initial:n        = \normalsize,
    toc-section-style .value_required:n = true,
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Stat blocks
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Stat block title
    stat-block-title-family .tl_set:N         = \l__dnd_stat_block_title_family_tl,
    stat-block-title-family .initial:n        = \normalfont,
    stat-block-title-family .value_required:n = true,
    stat-block-title-style .tl_set:N         = \l__dnd_stat_block_title_style_tl,
    stat-block-title-style .initial:n        = \bfseries \scshape \LARGE,
    stat-block-title-style .value_required:n = true,
    % Stat block body
    stat-block-body-family .tl_set:N         = \l__dnd_stat_block_body_family_tl,
    stat-block-body-family .initial:n        = \__dnd_sf_initial_family:,
    stat-block-body-family .value_required:n = true,
    stat-block-body-style .tl_set:N         = \l__dnd_stat_block_body_style_tl,
    stat-block-body-style .initial:n        = \small,
    stat-block-body-style .value_required:n = true,
    % Stat block section
    stat-block-section-family .tl_set:N         = \l__dnd_stat_block_section_family_tl,
    stat-block-section-family .initial:n        = \sffamily,
    stat-block-section-family .value_required:n = true,
    stat-block-section-style .tl_set:N         = \l__dnd_stat_block_section_style_tl,
    stat-block-section-style .initial:n        = \color{titlered} \scshape \large,
    stat-block-section-style .value_required:n = true,
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Miscellaneous
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    % Footer
    footer-family .tl_set:N         = \l__dnd_footer_family_tl,
    footer-family .initial:n        = \normalfont,
    footer-family .value_required:n = true,
    footer-style .tl_set:N         = \l__dnd_footer_style_tl,
    footer-style .initial:n        = \scriptsize \textcolor{pagegold},
    footer-style .value_required:n = true,
    % Page number
    page-number-family .tl_set:N         = \l__dnd_page_number_family_tl,
    page-number-family .initial:n        = \normalfont,
    page-number-family .value_required:n = true,
    page-number-style .tl_set:N         = \l__dnd_page_number_style_tl,
    page-number-style .initial:n        = \scriptsize \textcolor{pagegold},
    page-number-style .value_required:n = true,
    % Drop caps
    drop-cap-family .tl_set:N         = \l__dnd_drop_cap_family_tl,
    drop-cap-family .initial:n        = \Royal,
    drop-cap-family .value_required:n = true,
    drop-cap-style .tl_set:N         = \l__dnd_drop_cap_style_tl,
    drop-cap-style .value_required:n = true,
  }

\NewDocumentCommand { \DndSetFonts } { o }
  {
    \keys_set:nn { dnd / fonts } { #1 }
  }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Font access functions combine the selected family and style
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Sectioning commands
\NewDocumentCommand{\DndFontPart}{}
  { \l__dnd_part_family_tl \l__dnd_part_style_tl}

\NewDocumentCommand{\DndFontChapter}{}
  { \l__dnd_chapter_family_tl \l__dnd_chapter_style_tl }

\NewDocumentCommand{\DndFontSection}{}
  { \l__dnd_section_family_tl \l__dnd_section_style_tl }

\NewDocumentCommand{\DndFontSubsection}{}
  { \l__dnd_subsection_family_tl \l__dnd_subsection_style_tl }

\NewDocumentCommand{\DndFontSubsubsection}{}
  { \l__dnd_subsubsection_family_tl \l__dnd_subsubsection_style_tl }

\NewDocumentCommand{\DndFontParagraph}{}
  { \l__dnd_paragraph_family_tl \l__dnd_paragraph_style_tl }

\NewDocumentCommand{\DndFontSubaragraph}{}
  { \l__dnd_subparagraph_family_tl \l__dnd_subparagraph_style_tl }

%% Tables
\NewDocumentCommand{\DndFontTableTitle}{}
  { \l__dnd_table_title_family_tl \l__dnd_table_title_style_tl }

\NewDocumentCommand{\DndFontTableBody}{}
  { \l__dnd_table_body_family_tl \l__dnd_table_body_style_tl }

%% Comment boxes
\NewDocumentCommand{\DndFontCommentTitle}{}
  { \l__dnd_comment_title_family_tl \l__dnd_comment_title_style_tl }

\NewDocumentCommand{\DndFontCommentBody}{}
  { \l__dnd_comment_body_family_tl \l__dnd_comment_body_style_tl }

%% Sidebars
\NewDocumentCommand{\DndFontSidebarTitle}{}
  { \l__dnd_sidebar_title_family_tl \l__dnd_sidebar_title_style_tl }

\NewDocumentCommand{\DndFontSidebarBody}{}
  { \l__dnd_sidebar_body_family_tl \l__dnd_sidebar_body_style_tl }

%% Read-aloud boxes
\NewDocumentCommand{\DndFontReadAloud}{}
  { \l__dnd_readaloud_family_tl \l__dnd_readaloud_style_tl }

%% Table of Contents
\NewDocumentCommand{\DndFontTocPart}{}
  { \l__dnd_toc_part_family_tl \l__dnd_toc_part_style_tl}

\NewDocumentCommand{\DndFontTocChapter}{}
  { \l__dnd_toc_chapter_family_tl \l__dnd_toc_chapter_style_tl}

\NewDocumentCommand{\DndFontTocSection}{}
  { \l__dnd_toc_section_family_tl \l__dnd_toc_section_style_tl}

%% Stat blocks
\NewDocumentCommand{\DndFontStatBlockTitle}{}
  { \l__dnd_stat_block_title_family_tl \l__dnd_stat_block_title_style_tl }

\NewDocumentCommand{\DndFontStatBlockBody}{}
  { \l__dnd_stat_block_body_family_tl \l__dnd_stat_block_body_style_tl }

\NewDocumentCommand{\DndFontStatBlockSection}{}
  { \l__dnd_stat_block_section_family_tl \l__dnd_stat_block_section_style_tl }

%% Miscellaneous
\NewDocumentCommand{\DndFontFooter}{}
  { \l__dnd_footer_family_tl \l__dnd_footer_style_tl }

\NewDocumentCommand{\DndFontPageNumber}{}
  { \l__dnd_page_number_family_tl \l__dnd_page_number_style_tl }

\NewDocumentCommand{\DndFontDropCap}{}
  { \l__dnd_drop_cap_family_tl \l__dnd_drop_cap_style_tl }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Drop Caps
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\renewcommand{\LettrineFontHook}
  { \l__dnd_drop_cap_family_tl \l__dnd_drop_cap_style_tl }

%% Usage: DndDropCapLine[<lettrine options>]{<first letter>}{<small caps line>}
%%    It takes trial and error to get the 2nd argument to align with
%%    the linebreak. Lettrine package will not play nicely with \FirstLine. See
%%    the lettrine package for options.
\NewDocumentCommand{\DndDropCapLine}{ O{} m m }
  {
    \lettrine[
        lines   = 4,
        depth   = 0,
        findent = \l__dnd_space_dim,
        nindent = 0pt,
        #1
      ]
      {#2}
      {#3}
  }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Contour that can break across lines. Can accept \newline to force a break.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\cs_new_protected:Npn \__dnd_contour_preserve_space:nn #1#2
  {
    \group_begin:
    \seq_set_split:Nnn \l_tmpa_seq { ~ } { #2 }
    \seq_set_map:NNn \l_tmpb_seq \l_tmpa_seq { \exp_not:n {\contour{#1}{##1}} }
    \seq_use:Nn \l_tmpb_seq { ~ }
    \group_end:
  }

\NewDocumentCommand{\DndContour}{ O{contourgray} m }
  {
    \group_begin:
    \seq_set_split:Nnn \l_tmpa_seq { \newline } { #2 }
    \seq_set_map:NNn \l_tmpb_seq \l_tmpa_seq { \exp_not:n {\__dnd_contour_preserve_space:nn{#1}{##1}} }
    \seq_use:Nn \l_tmpb_seq { \newline }
    \group_end:
  }
%</dndfonts>
%<*dndheader>
\ExplSyntaxOn

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Custom headers and footers
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\bool_if:NT \l__dnd_layout_bool
  {
\RequirePackage {fancyhdr} % Adaptation of the footers

%% Setup for custom footer
\pagestyle {fancy}

\cs_if_free:NF \chaptermark
  {
    \renewcommand*{\chaptermark}[1]
      {
        \markboth
          {
            \MakeUppercase
              {
                \ifnum\value{secnumdepth}>-1
                  \chaptername\ \thechapter :~
                \fi
                #1
              }
          }
          {}
      }
  }

\renewcommand*{\headrulewidth}{0pt} % no rule for header
\renewcommand*{\footrulewidth}{0pt} % no rule for footer

\fancyhf {} % clear all headers and footers

%% Header is used to include the page background
\fancyhead{
  \bool_if:NT \l__dnd_show_background_bool
    {
    \begin{tikzpicture}[remember~picture,overlay]
      \node[inner~sep=0pt] at (current~page.center) {\includegraphics[width=\paperwidth,height=\paperheight]{img/paper}};
    \end{tikzpicture}
    }
}

%% Left-even page footer
\fancyfoot[LE]{%
    \DndFontFooter \leftmark
    \begin{tikzpicture}[remember~picture,overlay]
      \bool_if:NT \l__dnd_show_footer_scroll_bool {
        \node[xscale=-1,inner~sep=0pt,anchor=south,nearly~opaque] at (current~page.south) {\includegraphics[width=\paperwidth,height=.6in]{img/footerscroll}};
      }
      \node[inner~sep=0pt,anchor=south,xshift=.28in,yshift=.39in] at (current~page.south~west) {\DndFontPageNumber \thepage};
    \end{tikzpicture}
  }

%% Right-odd page footer
\fancyfoot[RO]{%
    \DndFontFooter \leftmark
    \begin{tikzpicture}[remember~picture,overlay]
      \bool_if:NT \l__dnd_show_footer_scroll_bool {
        \node[inner~sep=0pt,anchor=south,nearly~opaque] at (current~page.south) {\includegraphics[width=\paperwidth,height=.6in]{img/footerscroll}};
      }
      \node[inner~sep=0pt,anchor=south,xshift=-.28in,yshift=.39in] at (current~page.south~east) {\DndFontPageNumber \thepage};
    \end{tikzpicture}
  }

\fancypagestyle {plain} {}

\fancypagestyle{empty}{%
  \fancyfoot{}
}

}
%</dndheader>
%<*dndreadaloud>
\ExplSyntaxOn

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Environment for read-aloud text.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Standard for every read-aloud text
\DeclareTColorBox {__dnd_read_aloud} {o}
  {
    before~upper    =
      {
        \bool_if:NT \l__dnd_layout_bool
          {
            \bool_if:NF \l__dnd_justified_bool
              {\RaggedRight}
          }
      },
    code            = {\linespread {1.1} },
    enhanced~jigsaw,
    frame~hidden,
    boxrule         = 0pt,
    breakable,
    enhanced,
    before~skip     = 13pt plus 4pt minus 4pt,
    boxsep          = 8pt,
    top             = 0pt,
    left            = 0pt,
    right           = 0pt,
    bottom          = 0pt,
    sharp~corners,
    parbox          = false,
    borderline~west = {1pt} {-0.5pt} {titlered},
    borderline~east = {1pt} {-0.5pt} {titlered},
    fontupper       = \DndFontReadAloud,
    fontlower       = \DndFontReadAloud,
    overlay         =
      {
        \foreach\n ~ in ~ { north~east, north~west, south~east, south~west }
        {\draw [ titlered, fill = titlered ] ( frame.\n ) circle (1.5pt); };
      },
    after~skip      = 13pt plus 4pt minus 4pt,
    #1,
  }

%% Extra key for controlling the color of the title and the background
\keys_define:nn { dnd / read_aloud }
  {
    color .tl_set:N         = \l__dnd_read_aloud_color_tl,
    color .initial:n        = readaloudcolor,
    color .value_required:n = true,
  }

%% This function, through its variant, forces the expansion of the tcb keys
%% passed to the environment by the user before it invokes the tcolorbox
\cs_new_protected:Nn \__dnd_start_read_aloud:nn
  {
    \begin {__dnd_read_aloud} [ #1, #2 ]
  }

\cs_generate_variant:Nn \__dnd_start_read_aloud:nn { nV }

%% The DndReadAloud environment
%% #1 - keys. We handle the custom color key before passing other keys on
\NewDocumentEnvironment {DndReadAloud} {o}
  {
    \group_begin:
    \keys_set_known:nnN { dnd / read_aloud } {#1} \l_tmpa_tl

    \str_if_eq:VnT \l_tmpa_tl { -NoValue- }
      { \tl_set_eq:NN \l_tmpa_tl \c_empty_tl }

    \__dnd_start_read_aloud:nV
      {
          colback = \l__dnd_read_aloud_color_tl,
      }
      {\l_tmpa_tl}
  }
  {
    \end {__dnd_read_aloud}
    \group_end:
  }
%</dndreadaloud>
%<*dndsections>
\ExplSyntaxOn

\bool_if:NT \l__dnd_layout_bool
{
  % Change part numbering to Arabic numbers from Roman numerals
  \renewcommand{\thepart}{\arabic{part}}

  % Set spacing around floats
  \setlength{\textfloatsep}{11pt plus 4pt minus 4pt}
  \setlength{\intextsep}{11pt plus 4pt minus 4pt}
  \setlength{\dbltextfloatsep}{11pt plus 4pt minus 4pt}

  % Remove Numbering (If you want Numbering set secnumdepth to the appropriate depth)
  \setcounter{secnumdepth}{0}

  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  % Section formatting
  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  % Part
  \titleformat {\part}
    [display]
    { \centering \DndFontPart } % format
    { \DndContour{\partname\ \thepart} } % label
    { 2ex } % sep
    { \DndContour } % before-code

  % Chapter
  \titleformat {\chapter}
    { \DndFontChapter } % format
    { \DndContour{\chaptertitlename\ \thechapter :} } % label
    { \wordsep } % sep
    { \DndContour } % before-code

  \titlespacing* {\chapter}
    { 0pt }  % left
    { .3ex }  % before-sep
    { 2.8ex } % after-sep

  % Section
  \titleformat {\section}
    { \DndFontSection } % format
    { \thesection } % label
    { 1em } % sep
    { \nopagebreak } % before-code

  \titlespacing* { \section }
    { 0pt } % left
    { 1.3ex plus .43ex minus .43ex } % before-sep
    { 0pt } % after-sep

  % Subsection
  \titleformat {\subsection}
    { \DndFontSubsection } % format
    { \thesubsection } % label
    { 1em } % sep
    { \nopagebreak } % before-code
    [ \vspace{-.3ex} \titleline{ \color{titlegold} \titlerule[1pt] } ] % after-code

  \titlespacing*{ \subsection }
    { 0pt } % left
    { 1.4ex plus .47ex minus .47ex } % before-sep
    { 1.2ex } % after-sep

  % Subsubsection
  \titleformat {\subsubsection}
    { \DndFontSubsubsection } % format
    { \thesubsubsection } % label
    { 1em } % sep
    { \nopagebreak } % before-code

  \titlespacing* { \subsubsection }
    { 0pt } % left
  { 2ex plus .67ex minus .67ex } % before-sep
    { .2ex } % after-sep

  % Paragraph
  \titleformat {\paragraph} [runin]
    { \DndFontParagraph } % format
    { \theparagraph \quad } % label
    {0pt} % sep
    {}    % before-code
    [.]   % after-code

  \titlespacing* {\paragraph}
    {0pt}      % left
    {\parskip} % before-sep
    {\wordsep} % after-sep

  % Subparagraph
  \titleformat {\subparagraph} [runin]
    { \DndFontSubaragraph } % format
    { \thesubparagraph \quad } % label
    {0pt} % sep
    {}    % before-code
    [.]   % after-code

  \titlespacing* {\subparagraph}
    {\parindent} % left
    {\parskip}   % before-sep
    {\wordsep}   % after-sep
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Special command for magic items, traps, and the like.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\NewDocumentCommand {\DndFeatHeader} { m o }
  {
    \subsection {#1}
    \IfValueT{#2}
      {
        \textit {#2}
        \par \vspace{3pt} \noindent \ignorespaces
      }
  }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Special command for magic items, traps, and the like.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\NewDocumentCommand {\DndItemHeader} { m m }
  {
    \subsubsection {#1}
    \textit {#2}
    \par \vspace{3pt} \noindent \ignorespaces
  }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Special command for spells.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% #1 - Name
%% #2 - Level and school
%% #3 - Casting time
%% #4 - Range
%% #5 - Components
%% #6 - Duration
\NewDocumentCommand {\DndSpellHeader} { m m m m m m }
  {
    \DndItemHeader {#1} {#2}

    \begin{description}
      [
        nosep,
        labelsep = \l__dnd_space_dim,
        after    = { \vspace{4pt plus 1pt minus 1pt} },
      ]
      \item [ \spellcastingtimename : ] #3
      \item [ \spellrangename       : ] #4
      \item [ \spellcomponentsname  : ] #5
      \item [ \spelldurationname    : ] #6
    \end{description}
  }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Map Areas and their References
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\tl_new:N \l__dnd_area_num_depth_tl

%% Options
\keys_define:nn { dnd / areas }
  {
    area-label .tl_set:N          = \l__dnd_area_label_tl,
    area-label .initial:n         = area,
    area-label .value_required:n  = true,
    sub-area-label .tl_set:N          = \l__dnd_sub_area_label_tl,
    sub-area-label .initial:n         = subarea,
    sub-area-label .value_required:n  = true,
    region .tl_set:N          = \l__dnd_region_tl,
    region .value_required:n  = true,
    area-num-depth .choice:,
    area-num-depth .choices:nn =
      { 1, 2, 3, 4 }
      { \tl_set:Nn \l__dnd_area_num_depth_tl {\l_keys_choice_tl} },
    area-num-depth .initial:n  = 2, % subsection
  }

\NewDocumentCommand {\DndSetAreaOptions} {o}
  {
    \keys_set:nn { dnd / areas } { #1 }
  }

%% Counters
\newcounter {DndAreaCounter}

\NewDocumentCommand {\DndResetAreas} {}
  {
    \setcounter {DndAreaCounter} {0}
  }

\newcounter {DndSubAreaCounter} [DndAreaCounter]

%% sub area references should be '5a', '5b', not '51', '52'
\renewcommand \p@DndSubAreaCounter { \arabic {DndAreaCounter} }
\renewcommand \theDndSubAreaCounter { \alph {DndSubAreaCounter} }

%% Functions to create an area including text and label
\NewDocumentCommand {\DndArea} {m}
  {
    \refstepcounter {DndAreaCounter}
    \label { \l__dnd_region_tl \l__dnd_area_label_tl :#1 }

    \tl_set:Nn \l_tmpa_tl { \l__dnd_region_tl \arabic {DndAreaCounter} . ~ #1 }

    \str_case_e:nn {\l__dnd_area_num_depth_tl}
      {
        {1} { \section       {\l_tmpa_tl} }
        {2} { \subsection    {\l_tmpa_tl} }
        {3} { \subsubsection {\l_tmpa_tl} }
        {4} { \paragraph     {\l_tmpa_tl} }
      }
  }

\NewDocumentCommand {\DndSubArea} {m}
  {
    \refstepcounter {DndSubAreaCounter}
    \label { \l__dnd_region_tl \l__dnd_sub_area_label_tl : #1 }

    \tl_set:Nn \l_tmpa_tl { \l__dnd_region_tl \arabic {DndAreaCounter} \alph {DndSubAreaCounter} . ~ #1 }

    \str_case_e:nn {\l__dnd_area_num_depth_tl}
      {
        {1} { \subsection    {\l_tmpa_tl} }
        {2} { \subsubsection {\l_tmpa_tl} }
        {3} { \paragraph     {\l_tmpa_tl} }
        {4} { \subparagraph  {\l_tmpa_tl} }
      }

  }

%% Functions to reference a label
\NewDocumentCommand {\DndAreaRef} { o m }
  {
    \group_begin:
      \keys_set:nn { dnd / areas } {#1} % Temp set keys to reference other regions
      #2 ~ ( \pageabbreviationname\ \pageref { \l__dnd_region_tl \l__dnd_area_label_tl : #2 } )
    \group_end:
  }

\NewDocumentCommand {\DndSubAreaRef} { o m }
  {
    \group_begin:
      \keys_set:nn { dnd / areas } { #1 } % Temp set keys to reference other regions
      #2 ~ ( \pageabbreviationname\ \pageref { \l__dnd_region_tl \l__dnd_sub_area_label_tl : #2 } )
    \group_end:
  }
%</dndsections>
%<*dndmonster>
\ExplSyntaxOn

\NewDocumentCommand {\DndCRExp} { m }
  {
    \str_case_e:nnF {#1}
      {
        {0} {#1~(0~\xpname)}
        {1/10} {0~(10~\xpname)}
        {1/8} {#1~(25~\xpname)}
        {1/4} {#1~(50~\xpname)}
        {1/2} {#1~(100~\xpname)}
        {1} {#1~(200~\xpname)}
        {2} {#1~(450~\xpname)}
        {3} {#1~(700~\xpname)}
        {4} {#1~(\numprint{1100}~\xpname)}
        {5} {#1~(\numprint{1800}~\xpname)}
        {6} {#1~(\numprint{2300}~\xpname)}
        {7} {#1~(\numprint{2900}~\xpname)}
        {8} {#1~(\numprint{3900}~\xpname)}
        {9} {#1~(\numprint{5000}~\xpname)}
        {10} {#1~(\numprint{5900}~\xpname)}
        {11} {#1~(\numprint{7200}~\xpname)}
        {12} {#1~(\numprint{8400}~\xpname)}
        {13} {#1~(\numprint{10000}~\xpname)}
        {14} {#1~(\numprint{11500}~\xpname)}
        {15} {#1~(\numprint{13000}~\xpname)}
        {16} {#1~(\numprint{15000}~\xpname)}
        {17} {#1~(\numprint{18000}~\xpname)}
        {18} {#1~(\numprint{20000}~\xpname)}
        {19} {#1~(\numprint{22000}~\xpname)}
        {20} {#1~(\numprint{25000}~\xpname)}
        {21} {#1~(\numprint{33000}~\xpname)}
        {22} {#1~(\numprint{41000}~\xpname)}
        {23} {#1~(\numprint{50000}~\xpname)}
        {24} {#1~(\numprint{62000}~\xpname)}
        {25} {#1~(\numprint{75000}~\xpname)}
        {26} {#1~(\numprint{90000}~\xpname)}
        {27} {#1~(\numprint{105000}~\xpname)}
        {28} {#1~(\numprint{120000}~\xpname)}
        {29} {#1~(\numprint{135000}~\xpname)}
        {30} {#1~(\numprint{155000}~\xpname)}
      }
      {#1}
  }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Monster environments
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Stat block made to look like the Monster Manual NPC definitions
\DeclareTColorBox {DndMonsterNoBg} { O{} m }
  {
    enhanced,
    frame~hidden,
    boxrule     = 0pt,
    breakable,
    parbox      = false,
    boxsep      = 0pt,
    toptitle    = 3mm,
    left        = 0pt,
    right       = 0pt,
    sharp~corners,
    opacityback = 0,
    colframe    = titlered,
    fonttitle   = \DndFontStatBlockTitle,
    fontupper   = \DndFontStatBlockBody,
    fontlower   = \DndFontStatBlockBody,
    title       = {#2},
    coltitle    = titlered,
    #1
  }

%% Stat block made to look like stat blocks in the PHB.
\DeclareTColorBox {DndMonsterBg} { O{} m }
  {
    enhanced,
    frame~hidden,
    before~skip      = 12pt plus 3pt minus 3pt,
    boxrule          = 0pt,
    breakable,
    parbox           = false,
    boxsep           = 2pt,
    toptitle         = 8pt,
    top              = 0pt,
    left             = 2pt,
    right            = 2pt,
    bottom           = 7pt,
    sharp~corners,
    oversize         = 0pt,
    borderline~north = {3pt} {0pt}   {titlered},
    borderline~north = {2pt} {0.5pt} {statblockribbon},
    borderline~south = {3pt} {0pt}   {titlered},
    borderline~south = {2pt} {0.5pt} {statblockribbon},
    colback          = statblockbg,
    colbacktitle     = statblockbg,
    colframe         = titlered,
    fonttitle        = \DndFontStatBlockTitle,
    coltitle         = titlered,
    fontupper        = \DndFontStatBlockBody,
    fontlower        = \DndFontStatBlockBody,
    title            = {#2},
    #1
  }

%% Alias DndMonster to correct background type
\bool_if:NTF \l__dnd_show_background_bool
  {
    \let\DndMonster\DndMonsterBg
    \let\endDndMonster\endDndMonsterBg
  }{
    \let\DndMonster\DndMonsterNoBg
    \let\endDndMonster\endDndMonsterNoBg
  }

%% Italicized text appearing immediately after monster's name
\NewDocumentCommand {\DndMonsterType} {m}
  {
    \begin {hangingpar}
      \textit {#1}
    \end {hangingpar}
  }

%% Fancy DnD 5e stat block rule
\NewDocumentCommand {\DndMonsterLine} {}
  {
    \par \vspace{-2pt} \noindent
    \begin {tikzpicture}
      \draw [ rulered, fill = rulered ] ( 0, 0 ) -- ( 0, 0.1 ) -- ( \linewidth, 0.05 );
    \end {tikzpicture}
    \par
  }

%% A description variant used to list creature attributes.
\newlist {__dnd_monster_attributes} {description} {1}
\setlist [__dnd_monster_attributes]
  {
    before   = \color {titlered},
    font     = \DndFontStatBlockBody,
    labelsep = \l__dnd_space_dim,
    nosep,
  }

%% Only prints the item label if the value was supplied
\cs_new_protected_nopar:Npn \__dnd_if_monster_attribute:nn #1#2
  {
    \tl_if_empty:NF {#1}
      { \item [#2] #1 }
  }

%% Monster basics
\keys_define:nn { dnd / monster / basics }
  {
    armor-class .tl_set:N          = \l__armor_class_tl,
    armor-class .initial:n         = 10,
    armor-class .value_required:n  = true,
    armorclass .meta:n = { armor-class = {#1} },
    hit-points .tl_set:N         = \l__hit_points_tl,
    hit-points .initial:n        = \DndDice {1d8},
    hit-points .value_required:n = true,
    hitpoints .meta:n = { hit-points = {#1} },
    speed .tl_set:N         = \l__speed_tl,
    speed .initial:n        = 30 ~ \unitsname,
    speed .value_required:n = true,
  }

\cs_new_protected_nopar:Npn \__dnd_monster_basics:
  {
      \begin {__dnd_monster_attributes}
        \item [\armorclassname] \l__armor_class_tl
        \item [\hitpointsname]  \l__hit_points_tl
        \item [\speedname]      \l__speed_tl
      \end {__dnd_monster_attributes}
  }

\NewDocumentCommand {\DndMonsterBasics} {o}
  {
    \group_begin:
      \keys_set:nn { dnd / monster / basics } {#1}
      \DndMonsterLine
      \__dnd_monster_basics:
      \DndMonsterLine
    \group_end:
  }

%% Monster CR/XP helper
%% \l_tmpa_tl - CR
%% \l_tmpb_tl - XP
\cs_new_protected_nopar:Npn \__dnd_cr_xp:N #1
  {
    \tl_set:Nn \l_tmpa_tl {#1}
    \str_case_e:nnTF {#1}
      {
        {0}   { \tl_set:Nn \l_tmpb_tl {0} }
        {0/10}
          {
            \tl_set:Nn \l_tmpa_tl {0}
            \tl_set:Nn \l_tmpb_tl {10}
          }
        {1/10}
          {
            \dnd@deprecate{ Challenge ~ 1/10 } {0.8} [ Use ~ challenge ~ 0/10 ~ instead. ]
            \tl_set:Nn \l_tmpa_tl {0}
            \tl_set:Nn \l_tmpb_tl {10}
          }
        {1/8} { \tl_set:Nn \l_tmpb_tl {25} }
        {1/4} { \tl_set:Nn \l_tmpb_tl {50} }
        {1/2} { \tl_set:Nn \l_tmpb_tl {100} }
        {1}   { \tl_set:Nn \l_tmpb_tl {200} }
        {2}   { \tl_set:Nn \l_tmpb_tl {450} }
        {3}   { \tl_set:Nn \l_tmpb_tl {700} }
        {4}   { \tl_set:Nn \l_tmpb_tl {1100} }
        {5}   { \tl_set:Nn \l_tmpb_tl {1800} }
        {6}   { \tl_set:Nn \l_tmpb_tl {2300} }
        {7}   { \tl_set:Nn \l_tmpb_tl {2900} }
        {8}   { \tl_set:Nn \l_tmpb_tl {3900} }
        {9}   { \tl_set:Nn \l_tmpb_tl {5000} }
        {10}  { \tl_set:Nn \l_tmpb_tl {5900} }
        {11}  { \tl_set:Nn \l_tmpb_tl {7200} }
        {12}  { \tl_set:Nn \l_tmpb_tl {8400} }
        {13}  { \tl_set:Nn \l_tmpb_tl {10000} }
        {14}  { \tl_set:Nn \l_tmpb_tl {11500} }
        {15}  { \tl_set:Nn \l_tmpb_tl {13000} }
        {16}  { \tl_set:Nn \l_tmpb_tl {15000} }
        {17}  { \tl_set:Nn \l_tmpb_tl {18000} }
        {18}  { \tl_set:Nn \l_tmpb_tl {20000} }
        {19}  { \tl_set:Nn \l_tmpb_tl {22000} }
        {20}  { \tl_set:Nn \l_tmpb_tl {25000} }
        {21}  { \tl_set:Nn \l_tmpb_tl {33000} }
        {22}  { \tl_set:Nn \l_tmpb_tl {41000} }
        {23}  { \tl_set:Nn \l_tmpb_tl {50000} }
        {24}  { \tl_set:Nn \l_tmpb_tl {62000} }
        {25}  { \tl_set:Nn \l_tmpb_tl {75000} }
        {26}  { \tl_set:Nn \l_tmpb_tl {90000} }
        {27}  { \tl_set:Nn \l_tmpb_tl {105000} }
        {28}  { \tl_set:Nn \l_tmpb_tl {120000} }
        {29}  { \tl_set:Nn \l_tmpb_tl {135000} }
        {30}  { \tl_set:Nn \l_tmpb_tl {155000} }
      }
      { \l_tmpa_tl\ ( \numprint {\l_tmpb_tl} ~ \xpname ) }
      { #1 }
}

%% Monster details
\keys_define:nn { dnd / monster / details }
{
  saving-throws .tl_set:N         = \l__saving_throws_tl,
  saving-throws .value_required:n = true,
  savingthrows .meta:n = { saving-throws = {#1} },
  skills .tl_set:N         = \l__skills_tl,
  skills .value_required:n = true,
  damage-vulnerabilities .tl_set:N         = \l__damage_vulnerabilities_tl,
  damage-vulnerabilities .value_required:n = true,
  damagevulnerabilities .meta:n = { damage-vulnerabilities = {#1} },
  damage-resistances .tl_set:N         = \l__damage_resistances_tl,
  damage-resistances .value_required:n = true,
  damageresistances .meta:n = { damage-resistances = {#1} },
  damage-immunities .tl_set:N         = \l__damage_immunities_tl,
  damage-immunities .value_required:n = true,
  damageimmunities .meta:n = { damage-immunities = {#1} },
  condition-immunities .tl_set:N         = \l__condition_immunities_tl,
  condition-immunities .value_required:n = true,
  conditionimmunities .meta:n = { condition-immunities = {#1} },
  senses .tl_set:N         = \l__senses_tl,
  senses .initial:n        = \defaultsensesname,
  senses .value_required:n = true,
  languages .tl_set:N         = \l__languages_tl,
  languages .initial:n        = ---,
  languages .value_required:n = true,
  challenge .tl_set:N         = \l__challenge_tl,
  challenge .initial:n        = 1,
  challenge .value_required:n = true,
}

\cs_new_protected_nopar:Npn \__dnd_monster_details:
{
    \begin {__dnd_monster_attributes}
      \__dnd_if_monster_attribute:nn {\l__saving_throws_tl}          {\savesname}
      \__dnd_if_monster_attribute:nn {\l__skills_tl}                 {\skillsname}
      \__dnd_if_monster_attribute:nn {\l__damage_vulnerabilities_tl} {\dvulname}
      \__dnd_if_monster_attribute:nn {\l__damage_resistances_tl}     {\dresname}
      \__dnd_if_monster_attribute:nn {\l__damage_immunities_tl}      {\dimmname}
      \__dnd_if_monster_attribute:nn {\l__condition_immunities_tl}   {\cimmname}
      \item [\sensesname]    \l__senses_tl
      \item [\languagesname] \l__languages_tl
      \item [\challengename] \__dnd_cr_xp:N {\l__challenge_tl}
    \end {__dnd_monster_attributes}
}

\NewDocumentCommand {\DndMonsterDetails} {o}
{
  \group_begin:
    \keys_set:nn { dnd / monster / details } {#1}
    \DndMonsterLine{}
    \__dnd_monster_details:
    \DndMonsterLine{}
  \group_end:
}

%% Ability scores
%% Print ability score stats with auto-computed modifier
%% e.g. \stat{12} prints "12 (+1)"
\cs_new_protected_nopar:Npn \__dnd_ability_score_modifier:N #1
  {
    \regex_match:NnTF \c__pos_int_regex {#1}
      {
        \int_set:Nn \l_tmpa_int { \fp_eval:n { floor ( ( #1 - 10 ) / 2 ) } }

        #1 ~ (
        \int_compare:nNnTF {\l_tmpa_int} < {0}
        { -- }
        {+}
        \int_abs:n \l_tmpa_int )
      }
      {#1}
  }

\keys_define:nn { dnd / monster / ability_scores }
  {
    str .tl_set:N         = \l__str_tl,
    str .initial:n        = 10,
    str .value_required:n = true,
    STR .meta:n = { str = #1 },
    dex .tl_set:N         = \l__dex_tl,
    dex .initial:n        = 10,
    dex .value_required:n = true,
    DEX .meta:n = { dex = #1 },
    con .tl_set:N         = \l__con_tl,
    con .initial:n        = 10,
    con .value_required:n = true,
    CON .meta:n = { con = #1 },
    int .tl_set:N         = \l__int_tl,
    int .initial:n        = 10,
    int .value_required:n = true,
    INT .meta:n = { int = #1 },
    wis .tl_set:N         = \l__wis_tl,
    wis .initial:n        = 10,
    wis .value_required:n = true,
    WIS .meta:n = { wis = #1 },
    cha .tl_set:N         = \l__cha_tl,
    cha .initial:n        = 10,
    cha .value_required:n = true,
    CHA .meta:n = { cha = #1 },
  }

%% Ability scores in a table
\cs_new_protected_nopar:Npn \__dnd_monster_ability_scores:
  {
    \color {titlered}
    \par \vspace{1pt} \noindent
    \begin{tabularx} {\linewidth} {YYYYYY}
      \rule {0pt} {3.7mm} % adds space between hline and table
      \textbf {\strstatname} &
      \textbf {\dexstatname} &
      \textbf {\constatname} &
      \textbf {\intstatname} &
      \textbf {\wisstatname} &
      \textbf {\chastatname} \\
      \exp_args:NV \__dnd_ability_score_modifier:N \l__str_tl &
      \exp_args:NV \__dnd_ability_score_modifier:N \l__dex_tl &
      \exp_args:NV \__dnd_ability_score_modifier:N \l__con_tl &
      \exp_args:NV \__dnd_ability_score_modifier:N \l__int_tl &
      \exp_args:NV \__dnd_ability_score_modifier:N \l__wis_tl &
      \exp_args:NV \__dnd_ability_score_modifier:N \l__cha_tl
    \end{tabularx}

    \par \vspace{4pt}%
  }

\NewDocumentCommand {\DndMonsterAbilityScores} {o}
  {
    \group_begin:
      \keys_set:nn { dnd / monster / ability_scores } {#1}
      \__dnd_monster_ability_scores:
    \group_end:
  }

%% Inline header for monster actions - similar to a paragraph
\NewDocumentCommand {\DndMonsterAction} {m}
  { \par \smallskip \noindent \textsl { \textbf {#1.} } }

%% Inline header for monster sub actions - similar to a subparagraph
\NewDocumentCommand {\DndMonsterSubAction} {m}
  { \par \textsl { \textbf {#1.} } }

%% Monster subsection header style
\NewDocumentCommand {\DndMonsterSection} {m}
  {
    \addvspace{6pt plus 2pt minus 2pt} \noindent
    \group_begin:
      \DndFontStatBlockSection #1\nopagebreak[4]
      % \rule is a horizontal command, so placing it under the title incurs extra
      % line spacing. Use \hrule (a vertical command) instead.
      \vspace {2pt}\nopagebreak[4]
      \hrule height 0.6pt
    \group_end:
      \par \vspace{5pt}
    \noindent \ignorespaces
  }

%% Spellcasting levels
\newlist {DndMonsterSpells} {description} {1}
\setlist [DndMonsterSpells]
  {
    font     = \normalfont \DndFontStatBlockBody,
    labelsep = \l__dnd_space_dim,
    noitemsep,
    topsep   = 6pt plus 2pt minus 2pt,
  }

\NewDocumentCommand {\DndEmphSpellString} {m}
  {
    \group_begin:
      \seq_set_from_clist:Nn \l_tmpa_seq {#1}
      \seq_set_map:NNn \l_tmpb_seq \l_tmpa_seq { \exp_not:n { \emph {##1} } }
      \seq_use:Nn \l_tmpb_seq { ,~ }
    \group_end:
  }

\NewDocumentCommand {\DndInnateSpellLevel} { O {\innateatwillname} m }
  {
    \item
      [
        \regex_match:NnTF \c__pos_int_regex {#1}
        {
          \str_if_in:NnTF {#2} {,}
          { \__dnd_caption:nn {\numberperdayeachname} {#1} }
          { \__dnd_caption:nn {\numberperdayname} {#1} }
        }
        {#1}
        :
      ]
      \DndEmphSpellString {#2}
  }

\NewDocumentCommand {\DndMonsterSpellLevel} { O{\spellcantripsname} O{\spellatwillname} m }
  {
    \item
      [
        \str_case_e:nnF {#1}
          {
            {1} {\spellfirstlevelname}
            {2} {\spellsecondlevelname}
            {3} {\spellthirdlevelname}
            {4} {\spellfourthlevelname}
            {5} {\spellfifthlevelname}
            {6} {\spellsixthlevelname}
            {7} {\spellseventhlevelname}
            {8} {\spelleighthlevelname}
            {9} {\spellninthlevelname}
          }
          {#1}
        {~}(
        \str_case_e:nnF {#2}
          {
            {1} {\spelloneslotname}
            {2} {\spelltwoslotsname}
            {3} {\spellthreeslotsname}
            {4} {\spellfourslotsname}
          }
          {#2}
        ) :
      ]
    \DndEmphSpellString{#3}
  }

%% Monster attacks
\tl_new:N \l__dnd_attack_distance_tl
\tl_new:N \l__dnd_attack_type_tl

\keys_define:nn { dnd / monster / attack }
  {
    name .tl_set:N         = \l__name_tl,
    name .value_required:n = true,
    distance .choice:,
    distance .choices:nn =
      { both, melee, ranged }
      { \tl_set:Nn \l__dnd_attack_distance_tl {\l_keys_choice_tl} },
    distance .initial:n  = both,
    type .choice:,
    type / weapon .code:n = { \tl_set:Nn \l__dnd_attack_type_tl {\weaponname} },
    type / spell .code:n = { \tl_set:Nn \l__dnd_attack_type_tl {\spellname} },
    type .initial:n  = weapon,
    mod .tl_set:N         = \l__mod_tl,
    mod .value_required:n = true,
    reach .tl_set:N         = \l__reach_tl,
    reach .initial:n        = 5,
    reach .value_required:n = true,
    range .tl_set:N         = \l__range_tl,
    range .initial:n        = 20/60,
    range .value_required:n = true,
    targets .tl_set:N         = \l__targets_tl,
    targets .initial:n        = \defaulttargetsname,
    targets .value_required:n = true,
    dmg .tl_set:N         = \l__dmg_tl,
    dmg .value_required:n = true,
    dmg-type .tl_set:N         = \l__dmg_type_tl,
    dmg-type .value_required:n = true,
    plus-dmg .tl_set:N         = \l__plus_dmg_tl,
    plus-dmg .value_required:n = true,
    plus-dmg-type .tl_set:N         = \l__plus_dmg_type_tl,
    plus-dmg-type .value_required:n = true,
    or-dmg .tl_set:N         = \l__or_dmg_tl,
    or-dmg .value_required:n = true,
    or-dmg-when .tl_set:N         = \l__or_dmg_when_tl,
    or-dmg-when .value_required:n = true,
    extra .tl_set:N         = \l__extra_tl,
    extra .value_required:n = true,
  }

\cs_new_protected:Npn \__dnd_monster_reach:
  {
    \reachname\ \l__reach_tl\ \unitsname
  }

\cs_new_protected:Npn \__dnd_monster_range:
  {
    \rangename\ \l__range_tl\ \unitsname
  }

\cs_new_protected:Npn \__dnd_if_plus_dmg:
  {
    \tl_if_empty:NF {\l__plus_dmg_tl}
    { ~ \plusname\ \l__plus_dmg_tl\ \l__plus_dmg_type_tl\ \damagename }
  }

\cs_new_protected_nopar:Npn \__dnd_if_or_dmg:
  {
    \tl_if_empty:NF {\l__or_dmg_tl}
    {
      , ~ \orname\ \l__or_dmg_tl\ \l__dmg_type_tl\ \damagename\ \l__or_dmg_when_tl

      \tl_if_empty:NF {\l__plus_dmg_tl}
        {,}
    }
  }

\cs_new_protected:Npn \__dnd_monster_attack:
  {
    \__dnd_check_for_key:Nnn \l__name_tl {\DndMonsterAttack} {name}
    \__dnd_check_for_key:Nnn \l__mod_tl {\DndMonsterAttack} {mod}

    \begin{DndMonsterAction} {\l__name_tl}~

      \str_case_e:nnF {\l__dnd_attack_distance_tl}
        {
          { melee }
            {
              \textit{ \__dnd_caption:nn {\meleeattackname} {\l__dnd_attack_type_tl} : } ~ \__dnd_caption:nn {\tohitname} {\l__mod_tl}, ~ \__dnd_monster_reach:
            }
          { ranged }
            {
              \textit{ \__dnd_caption:nn {\rangedattackname} {\l__dnd_attack_type_tl} : } ~ \__dnd_caption:nn {\tohitname} {\l__mod_tl}, ~ \__dnd_monster_range:
            }
        }
        {% Melee and Ranged is the default
          \textit{ \__dnd_caption:nn {\meleeorrangedattackname} {\l__dnd_attack_type_tl} : } ~ \__dnd_caption:nn {\tohitname} {\l__mod_tl}, ~ \__dnd_monster_reach:\ \orname\ \__dnd_monster_range:
        }
      , ~ \l__targets_tl. ~
      \textit { \hitname : } ~

      \str_if_empty:NF {\l__dmg_tl} % Don't show any damage if `dmg' is not set.
        {
          \l__dmg_tl\ \l__dmg_type_tl\ \damagename
          \__dnd_if_or_dmg:
          \__dnd_if_plus_dmg:
        }

      % `extra' is any special text that goes after the final damage; do not
      % include the final full stop.
      \l__extra_tl .
    \end{DndMonsterAction}
  }

\NewDocumentCommand {\DndMonsterAttack} {o}
  {
    \group_begin:
      \keys_set:nn { dnd / monster / attack } {#1}
      \__dnd_monster_attack:
    \group_end:
  }

\NewDocumentCommand {\DndMonsterMelee} {o}
  {
    \group_begin:
      \keys_set:nn { dnd / monster / attack } { #1, distance = melee }
      \__dnd_monster_attack:
    \group_end:
  }

\NewDocumentCommand {\DndMonsterRanged} {o}
  {
    \group_begin:
      \keys_set:nn { dnd / monster / attack } { #1, distance = ranged }
      \__dnd_monster_attack:
    \group_end:
  }

%% Legendary Actions

\newlist {DndMonsterLegendaryActions} {description} {1}
\setlist [DndMonsterLegendaryActions]
  {
    font     = \DndFontStatBlockBody,
    labelsep = \l__dnd_space_dim,
    noitemsep,
    topsep   = 6pt plus 2pt minus 2pt,
  }

\NewDocumentCommand {\DndMonsterLegendaryAction} { m m }
  {
    \item [ #1 . ] #2
  }

%</dndmonster>
%<*dndtoc>
\ExplSyntaxOn

\bool_if:NT \l__dnd_layout_bool
{
  \RequirePackage{titletoc}

  % Makes the TOC go to section depth
  \setcounter{tocdepth}{1}

  \titlecontents{part}
    [0pt] % left
    { \addvspace{.06in} \DndFontTocPart } % above-code
    {\partname\ \thecontentslabel :~ } % numbered-entry-format
    {} % numberless-entry-format
    {} % filler-page-format
    [ \addvspace{-.03in} \titleline{ \color{titlegold} \titlerule[1pt] } \addvspace{.05in } ] % below-code

  \titlecontents{chapter}
    [0pt] % left
    { \addvspace{.1in} \DndFontTocChapter } % above-code
    {\tocchapterabbreviationname\ \thecontentslabel :~ } % numbered-entry-format
    {} % numberless-entry-format
    {\titlerule*{.}\contentspage} % filler-page-format

  \titlecontents{section}
    [0pt] % left
    {\DndFontTocSection} % above-code
    {\thecontentslabel :~ } % numbered-entry-format
    {} % numberless-entry-format
    {\titlerule*{.}\contentspage} % filler-page-format
}
%</dndtoc>
%<*dndtable>
\ExplSyntaxOn

%% Centered Column
\newcolumntype { Y }
  { > { \centering \arraybackslash } X }

%% Table options
\keys_define:nn { dnd / table }
  {
    color .tl_set:N         = \l__dnd_table_color_tl,
    color .initial:n        = tablecolor,
    color .value_required:n = true,
    header .tl_set:N         = \l__dnd_table_header_tl,
    header .value_required:n = true,
    width .dim_set:N        = \l__dnd_table_width_dim,
    width .value_required:n = true,
  }

  % Table Definition
  \NewDocumentEnvironment {DndTable} { o m }
  {
    \group_begin:

    \dim_set:Nn \l__dnd_table_width_dim { \linewidth }
    \tl_if_novalue:nF {#1}
      { \keys_set:nn { dnd / table } {#1} }

    \par \vspace { 9pt plus 3pt minus 3pt } \noindent

    \tl_if_empty:NF \l__dnd_table_header_tl
      {
        \group_begin:
          \DndFontTableTitle \l__dnd_table_header_tl \nopagebreak
          \par \vspace{ 5pt plus 2pt minus 2pt } \noindent
        \group_end:
      }

    \DndFontTableBody

    \rowcolors {1} {} {\l__dnd_table_color_tl}

    \tabularx {\l__dnd_table_width_dim} {#2}
  }
  {
    \endtabularx \vspace { 9pt plus 3pt minus 3pt }

    \group_end:
  }
%</dndtable>
%<*compat>
\ExplSyntaxOn

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Compatibility with external packages
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\cs_if_free:NT \str_case_e:nnF
  {
    % \str_case_x was renamed \str_case_e mid-2018. \str_case_x will be removed
    % at the end of 2019:
    %
    %   https://github.com/latex3/latex3/blob/8fcb571ddda61c01773d9746d32cecdbe63afb26/l3kernel/l3obsolete.txt#L65
    \cs_new_eq:NN \str_case_e:nnF \str_case_x:nnF
  }
%</compat>
%<*dndsidebar>
\ExplSyntaxOn

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Environment for sidebars.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Standard for every sidebar
\DeclareTColorBox {__dnd_sidebar} {o}
  {
    before~upper     =
      {
        \bool_if:NT \l__dnd_layout_bool
          {
            \bool_if:NF \l__dnd_justified_bool
              {\RaggedRight}
          }
      },
    code={\linespread{.9}},
    frame~hidden,
    boxrule          = 0pt,
    enhanced,
    before~skip      = 13pt plus 4pt minus 4pt,
    toptitle         = 2pt,
    boxsep           = 3pt,
    left             = 6pt,
    right            = 6pt,
    top              = 0pt,
    bottom           = 2pt,
    fonttitle        = \DndFontSidebarTitle,
    fontupper        = \DndFontSidebarBody,
    fontlower        = \DndFontSidebarBody,
    sharp~corners,
    parbox           = false,
    borderline~north = {1pt} {-0.5pt} {black},
    borderline~south = {1pt} {-0.5pt} {black},
    coltitle         = black,
    fuzzy~shadow     = {0mm} {-3.5pt} {-0.5pt} {0.4mm} {black!60!white},
    overlay          =
      {
        \fill [black] ( frame.south~west ) -- ++ (  7pt, 0 ) -- ++ ( 0, -5pt ) -- cycle;
        \fill [black] ( frame.north~west ) -- ++ (  7pt, 0 ) -- ++ ( 0,  5pt ) -- cycle;
        \fill [black] ( frame.north~east ) -- ++ ( -7pt, 0 ) -- ++ ( 0,  5pt ) -- cycle;
        \fill [black] ( frame.south~east ) -- ++ ( -7pt, 0 ) -- ++ ( 0, -5pt ) -- cycle;
      },
    after~skip       = 14pt plus 4pt minus 4pt,
    #1,
  }

%% Extra key for controlling the color of the title and the background
\keys_define:nn { dnd / sidebar }
  {
    color .tl_set:N         = \l__dnd_sidebar_color_tl,
    color .initial:n        = sidebarcolor,
    color .value_required:n = true,
  }

%% This function, through its variant, forces the expansion of the tcb keys
%% passed to the environment by the user before it invokes the tcolorbox
\cs_new_protected:Nn \__dnd_start_sidebar:nn
  {
    \begin {__dnd_sidebar} [ #1, #2 ]
  }

\cs_generate_variant:Nn \__dnd_start_sidebar:nn { nV }

%% The DndSidebar environment
%% #1 - keys. We handle the custom color key before passing other keys on
%% #2 - title.
\NewDocumentEnvironment {DndSidebar} { o m }
  {
    \group_begin:
    \keys_set_known:nnN { dnd / sidebar } {#1} \l_tmpa_tl

    \str_if_eq:VnT \l_tmpa_tl { -NoValue- }
      { \tl_set_eq:NN \l_tmpa_tl \c_empty_tl }

    \__dnd_start_sidebar:nV
      {
          colback      = \l__dnd_sidebar_color_tl,
          colbacktitle = \l__dnd_sidebar_color_tl,
          title        = {#2},
      }
      {\l_tmpa_tl}
  }
  {
    \end {__dnd_sidebar}
    \group_end:
  }
%</dndsidebar>
%<*dndutility>
\ExplSyntaxOn

%% Useful regex strings
\regex_const:Nn \c__pos_int_regex { \d+ }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Dice macro
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Matches { # | #d# | #d# + # | #d# - # } while ignoring spaces
\regex_const:Nn \c__valid_dice_regex { \A\s*(\d+)(?:[dD](\d+)\s*(?:([+\-])\s*(\d+))?)?\s*\Z }

\seq_new:N \l__dice_args_seq
\tl_new:N \l__dice_number_tl
\tl_new:N \l__dice_sides_tl
\tl_new:N \l__dice_mod_sign_tl
\tl_new:N \l__dice_mod_tl

\msg_new:nnn { dnd } { dice / invalid_argument } { Invalid~argument~``#1''~passed~to~\noexpand\DndDice. }

\NewDocumentCommand { \DndDice } { m }
  {
    \group_begin:
      \regex_extract_once:NnNTF { \c__valid_dice_regex } { #1 } \l__dice_args_seq
        {
          \seq_pop_left:NN \l__dice_args_seq \l_tmpa_str % Don't need the full match
          \seq_pop_left:NN \l__dice_args_seq \l__dice_number_tl % # of dice
          \seq_pop_left:NN \l__dice_args_seq \l__dice_sides_tl % # of sides
          \seq_pop_left:NN \l__dice_args_seq \l__dice_mod_sign_tl % +/- for add/sub
          \seq_pop_left:NN \l__dice_args_seq \l__dice_mod_tl % modifier

          \str_if_empty:NTF { \l__dice_sides_tl } % are there dice ?
            { \l__dice_number_tl } % No, just a number
            { %Yes, break down the roll
              \fp_eval:n { floor ( \l__dice_number_tl * ( \l__dice_sides_tl + 1 ) / 2 )\l__dice_mod_sign_tl \l__dice_mod_tl }~

              (
                \l__dice_number_tl d \l__dice_sides_tl

                \str_case_e:nn { \l__dice_mod_sign_tl }
                  {
                    { + } { ~+~\l__dice_mod_tl }
                    { - } { ~--~\l__dice_mod_tl }
                  }
              )
            }
        }
        { \msg_error:nnn { dnd } { dice / invalid_argument } { #1 }}
    \group_end:
  }
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Gets the width of a space
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\box_new:N \l__dnd_space_box
\hbox_set:Nn \l__dnd_space_box {~}
\dim_new:N \l__dnd_space_dim
\dim_set:Nn \l__dnd_space_dim { \box_wd:N \l__dnd_space_box }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Some keys are required for proper execution of macros.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\msg_new:nnn { dnd } { key_required } { #1~requires~key~``#2''~to~be~set. }

%% #1 - key value
%% #2 - macro name
%% #3 - key name
\cs_new_protected:Npn \__dnd_check_for_key:Nnn #1#2#3
  {
    \group_begin:
      \str_set:Nx \l_tmpa_str { #1 }

      \str_if_empty:NT { \l_tmpa_str }
        { \msg_error:nnnn { dnd } { key_required } { #2 } { #3 } }
    \group_end:
  }
%</dndutility>
%<*dndcomment>
\ExplSyntaxOn

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Environment for comments.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Standard for every comment
\DeclareTColorBox {__dnd_comment} {o}
  {
    before~upper =
      {
        \bool_if:NT \l__dnd_layout_bool
          {
            \bool_if:NF \l__dnd_justified_bool
              { \RaggedRight }
          }
      },
    code         = {\linespread{.9}},
    frame~hidden,
    boxrule      = 0pt,
    breakable,
    enhanced,
    before~skip  = 13pt plus 4pt minus 4pt,
    toptitle     = 2pt,
    boxsep       = 3pt,
    left         = 6pt,
    right        = 6pt,
    top          = 0pt,
    bottom       = 2pt,
    sharp~corners,
    fonttitle    = \DndFontCommentTitle,
    fontupper    = \DndFontCommentBody,
    fontlower    = \DndFontCommentBody,
    parbox       = false,
    coltitle     = black,
    after~skip   = 13pt plus 4pt minus 4pt,
    #1,
  }

%% Extra key for controlling the color of the title and the background
\keys_define:nn { dnd / comment }
  {
    color .tl_set:N         = \l__dnd_comment_color_tl,
    color .initial:n        = commentcolor,
    color .value_required:n = true,
  }

%% This function, through its variant, forces the expansion of the tcb keys
%% passed to the environment by the user before it invokes the tcolorbox
\cs_new_protected:Nn \__dnd_start_comment:nn
  {
    \begin {__dnd_comment} [ #1, #2 ]
  }

\cs_generate_variant:Nn \__dnd_start_comment:nn { nV }

%% The DndComment environment
%% #1 - keys. We handle the custom color key before passing other keys on
%% #2 - title.
\NewDocumentEnvironment {DndComment} { o m }
  {
    \group_begin:
    \keys_set_known:nnN { dnd / comment } {#1} \l_tmpa_tl

    \str_if_eq:VnT \l_tmpa_tl { -NoValue- }
      { \tl_set_eq:NN \l_tmpa_tl \c_empty_tl }

    \__dnd_start_comment:nV
      {
          colback      = \l__dnd_comment_color_tl,
          colbacktitle = \l__dnd_comment_color_tl,
          title        = {#2},
      }
      { \l_tmpa_tl }
  }
  {
    \end {__dnd_comment}
    \group_end:
  }
%</dndcomment>
%<*dndcolors>
\ExplSyntaxOn

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Define colors, sampled from the books.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Page
\definecolor {bgtan}    {HTML} {F7F2E5}	% DndReadAloud background
\definecolor {bgtan2018}{HTML} {F9EFD6} % lighter version of bgtan from the 2018 Basic Rules
\definecolor {pagegold} {HTML} {B89A67} % pagenumbers and footer

%% Type
\definecolor {titlered}    {HTML} {58180D} % titles
\definecolor {titlegold}   {HTML} {C9AD6A} % titlerules
\definecolor {rulered}     {HTML} {9C2B1B} % triangular rule in statsblock
\definecolor {contourgray} {HTML} {CACCBE} % outline color in part & chapter font

%% Type aliases
\colorlet {contourgrey} {contourgray}

%% Trim
\definecolor {BrGreen}       {HTML} {E8E6DC} % Basic Rules
\definecolor {PhbLightGreen} {HTML} {E0E5C1} % PHB Part 1
\definecolor {PhbLightCyan}  {HTML} {B5CEB8} % PHB Part 2
\definecolor {PhbMauve}      {HTML} {DCCCC5} % PHB Part 3
\definecolor {PhbTan}        {HTML} {E5D5AC} % PHB appendix
\definecolor {DmgLavender}   {HTML} {E3CED3} % DMG Part 1
\definecolor {DmgCoral}      {HTML} {F3D7C1} % DMG Part 2
\definecolor {DmgSlateGray}  {HTML} {DBE4E4} % DMG Part 3
\definecolor {DmgLilac}      {HTML} {D7D4D6} % DMG appendix

%% Trim aliases
\colorlet {DmgSlateGrey} {DmgSlateGray}

%% The color used in \DndSetThemeColor when a new color is not set
\colorlet {themecolor} {PhbLightGreen} % Set the default theme to Part 1 of the PHB.

%% Element colors that change when \DndSetThemeColor is used
\colorlet {commentcolor} {themecolor} % DndComment background
\colorlet {sidebarcolor} {themecolor} % DndSidebar background
\colorlet {tablecolor}   {themecolor} % DndTable even row background

%% Element colors that do not respond to \DndSetThemeColor
\colorlet {readaloudcolor} {bgtan} % DndReadAloud background
\definecolor {statblockribbon} {HTML} {E69A28} % stat block top/bottom borders (gold)
\definecolor {statblockbg}     {HTML} {FDF1DC} % stat block background (tan)

%% Sets the themecolor and colors for all themed elements
%% If called without the optional color, resets the color of all themed elements to the current themecolor
\NewDocumentCommand {\DndSetThemeColor} { O {themecolor} }
  {
    \colorlet {themecolor}   {#1}
    \colorlet {commentcolor} {#1}
    \colorlet {sidebarcolor} {#1}
    \colorlet {tablecolor}   {#1}
  }
%</dndcolors>
% \fi
